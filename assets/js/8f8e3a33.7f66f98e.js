"use strict";(self.webpackChunk_openfn_docs=self.webpackChunk_openfn_docs||[]).push([[19702],{17571:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>i,default:()=>u,frontMatter:()=>a,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"library/jobs/auto/promise-all-nested-requests","title":"Promises and nested requests","description":"\ud83d\udcdc This job is an official example from OpenFn.","source":"@site/adaptors/library/jobs/auto/promise-all-nested-requests.md","sourceDirName":"library/jobs/auto","slug":"/library/jobs/auto/promise-all-nested-requests","permalink":"/adaptors/library/jobs/auto/promise-all-nested-requests","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Promises and nested requests","sidebar_label":"\ud83d\udcdc Promises and nested requests","id":"promise-all-nested-requests","keywords":["library","job","expression","http","each","get","Promise"]},"sidebar":"adaptors","previous":{"title":"\ud83d\udcdc Chaining HTTP Requests","permalink":"/adaptors/library/jobs/auto/complex-http-request-chains"},"next":{"title":"\ud83d\udcdc Timeout to create a delay","permalink":"/adaptors/library/jobs/auto/timeout"}}');var r=n(74848),o=n(28453);const a={title:"Promises and nested requests",sidebar_label:"\ud83d\udcdc Promises and nested requests",id:"promise-all-nested-requests",keywords:["library","job","expression","http","each","get","Promise"]},i=void 0,d={},l=[{value:"Metadata",id:"metadata",level:2},{value:"Key Functions",id:"key-functions",level:2},{value:"Expression",id:"expression",level:2}];function c(e){const s={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(s.p,{children:["\ud83d\udcdc ",(0,r.jsx)("em",{children:"This job is an official example from OpenFn."})]}),"\n",(0,r.jsx)(s.h2,{id:"metadata",children:"Metadata"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Name: Promises and nested requests"}),"\n",(0,r.jsxs)(s.li,{children:["Adaptor: ",(0,r.jsx)(s.a,{href:"https://www.github.com/openfn/language-http",children:(0,r.jsx)(s.code,{children:"@openfn/language-http"})})]}),"\n",(0,r.jsxs)(s.li,{children:["Adaptor Version: ",(0,r.jsx)(s.a,{href:"https://www.github.com/openfn/language-http",children:(0,r.jsx)(s.code,{children:"latest"})})]}),"\n",(0,r.jsx)(s.li,{children:"Created date unknown"}),"\n",(0,r.jsx)(s.li,{children:"Updated date unknown"}),"\n",(0,r.jsxs)(s.li,{children:["Score: ",(0,r.jsx)("b",{children:"100"})," (an ",(0,r.jsx)(s.a,{href:"/adaptors/library/#library-scores",children:"indicator"})," of how useful this job may be)"]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"key-functions",children:"Key Functions"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"each"}),", ",(0,r.jsx)(s.code,{children:"get"}),", ",(0,r.jsx)(s.code,{children:"Promise"})]}),"\n",(0,r.jsx)(s.h2,{id:"expression",children:"Expression"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-js",children:"each(\n  '$.enrolledUsers[10]',\n  fn(state => {\n    const { host } = state.configuration;\n    const { id } = state.data;\n    const usersfields = [];\n    return get(\n      host,\n      {\n        query: {\n          wstoken: state.token,\n          wsfunction: 'core_user_get_users_by_field',\n          field: 'id',\n          'values[]': id,\n          moodlewsrestformat: 'json',\n        },\n      },\n      state => {\n        const { id, phone1, address } = state.data[0];\n        const fields = [\n          { id, 'Tel\xe9fono m\xf3vil': phone1, Direcci\xf3n: address, grades: [] },\n        ];\n        console.log(state.courseIds);\n        let promises = [];\n        state.courseIds.forEach(courseid => {\n          promises.push(\n            get(\n              host,\n              {\n                query: {\n                  wstoken: state.token,\n                  wsfunction: 'gradereport_user_get_grade_items',\n                  userid: id,\n                  courseid,\n                  moodlewsrestformat: 'json',\n                },\n              },\n              state => {\n                console.log('fetched');\n                const { graderaw } = state.data.usergrades[0].gradeitems[0];\n                const grades = [{ courseid, graderaw }];\n                fields[0].grades.push(...grades);\n              }\n            )(state)\n          );\n        });\n\n        return Promise.all(promises).then(() => {\n          usersfields.push(...fields);\n          return {\n            ...state,\n            usersfields,\n            enrolledUsers: [],\n            response: [],\n          };\n        });\n      }\n    )(state);\n  })\n);\n\n"})})]})}function u(e={}){const{wrapper:s}={...(0,o.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},28453:(e,s,n)=>{n.d(s,{R:()=>a,x:()=>i});var t=n(96540);const r={},o=t.createContext(r);function a(e){const s=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function i(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),t.createElement(o.Provider,{value:s},e.children)}}}]);