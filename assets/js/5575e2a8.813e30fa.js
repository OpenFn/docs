"use strict";(self.webpackChunk_openfn_docs=self.webpackChunk_openfn_docs||[]).push([[33015],{32784:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>_,contentTitle:()=>s,default:()=>p,frontMatter:()=>o,metadata:()=>i,toc:()=>d});var t=a(58168),r=(a(96540),a(15680));const o={title:"Q3 2022 Upsert Household & Household Visit in SF",sidebar_label:"Q3 2022 Upsert Household & Household Visit in SF",id:"Q3-2022-Upsert-Household-Household-Visit-in-SF-2022-06-28",keywords:["library","job","expression","salesforce","dataValue","field","fields","join","map","query","relationship","upsertIf","Array"]},s=void 0,i={unversionedId:"library/jobs/auto/Q3-2022-Upsert-Household-Household-Visit-in-SF-2022-06-28",id:"library/jobs/auto/Q3-2022-Upsert-Household-Household-Visit-in-SF-2022-06-28",title:"Q3 2022 Upsert Household & Household Visit in SF",description:"This job was provided by an OpenFn.org user via the job library API.",source:"@site/adaptors/library/jobs/auto/Q3-2022-Upsert-Household-Household-Visit-in-SF-2022-06-28.md",sourceDirName:"library/jobs/auto",slug:"/library/jobs/auto/Q3-2022-Upsert-Household-Household-Visit-in-SF-2022-06-28",permalink:"/adaptors/library/jobs/auto/Q3-2022-Upsert-Household-Household-Visit-in-SF-2022-06-28",draft:!1,tags:[],version:"current",frontMatter:{title:"Q3 2022 Upsert Household & Household Visit in SF",sidebar_label:"Q3 2022 Upsert Household & Household Visit in SF",id:"Q3-2022-Upsert-Household-Household-Visit-in-SF-2022-06-28",keywords:["library","job","expression","salesforce","dataValue","field","fields","join","map","query","relationship","upsertIf","Array"]},sidebar:"adaptors",previous:{title:"WF3-2a Repeat Failed Person Visits",permalink:"/adaptors/library/jobs/auto/WF3-2a-Repeat-Failed-Person-Visits-2023-05-31"},next:{title:"Q3 2022 Upsert Person",permalink:"/adaptors/library/jobs/auto/Q3-2022-Upsert-Person-2022-04-21"}},_={},d=[{value:"Metadata",id:"metadata",level:2},{value:"Key Functions",id:"key-functions",level:2},{value:"Expression",id:"expression",level:2}],l={toc:d},u="wrapper";function p(e){let{components:n,...a}=e;return(0,r.yg)(u,(0,t.A)({},l,a,{components:n,mdxType:"MDXLayout"}),(0,r.yg)("em",null,"This job was provided by an OpenFn.org user via the job library API."),(0,r.yg)("h2",{id:"metadata"},"Metadata"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Name: Q3 2022 Upsert Household & Household Visit in SF"),(0,r.yg)("li",{parentName:"ul"},"Adaptor: ",(0,r.yg)("a",{parentName:"li",href:"https://www.github.com/openfn/language-salesforce"},(0,r.yg)("inlineCode",{parentName:"a"},"@openfn/language-salesforce"))),(0,r.yg)("li",{parentName:"ul"},"Adaptor Version: ",(0,r.yg)("a",{parentName:"li",href:"https://www.github.com/openfn/language-salesforce"},(0,r.yg)("inlineCode",{parentName:"a"},"latest"))),(0,r.yg)("li",{parentName:"ul"},"Created over 2 years ago"),(0,r.yg)("li",{parentName:"ul"},"Updated 12 months ago"),(0,r.yg)("li",{parentName:"ul"},"Score: ",(0,r.yg)("b",null,"0")," (an ",(0,r.yg)("a",{parentName:"li",href:"/adaptors/library/#library-scores"},"indicator")," of how useful this job may be)")),(0,r.yg)("h2",{id:"key-functions"},"Key Functions"),(0,r.yg)("p",null,(0,r.yg)("inlineCode",{parentName:"p"},"dataValue"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"field"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"fields"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"join"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"map"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"query"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"relationship"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"upsertIf"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"Array")),(0,r.yg)("h2",{id:"expression"},"Expression"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-js"},"query(\n  `SELECT Id, Parent_Geographic_Area__c, Parent_Geographic_Area__r.Name, Parent_Geographic_Area__r.Parent_Geographic_Area__c FROM Location__c WHERE CommCare_User_ID__c = '${dataValue(\n    'properties.owner_id'\n  )(state)}'`\n);\n\nfn(state => { console.log(\"query1 done\"); return state; });\nfn(state => {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      console.log('4 second cooldown finished.');\n      resolve(state);\n    }, 4000);\n  });\n});\n\nfn(state => ({\n  ...state,\n  data: {\n    ...state.data,\n    villageNewId:\n      state.references[0].records && state.references[0].records.length !== 0\n        ? state.references[0].records[0].Id\n        : undefined,\n    areaNewId:\n      state.references[0].records && state.references[0].records.length !== 0\n        ? state.references[0].records[0].Parent_Geographic_Area__c\n        : undefined,\n    catchmentNewId:\n      state.references[0].records && state.references[0].records.length !== 0\n        ? (state.references[0].records[0].Parent_Geographic_Area__r \n          ? state.references[0].records[0].Parent_Geographic_Area__r.Parent_Geographic_Area__c\n          : undefined)\n        : undefined,\n  },\n}));\n\nupsertIf(\n   state.data.properties.commcare_username !== 'openfn.test' &&\n    state.data.properties.commcare_username !== 'test.2021' &&\n    state.data.properties.test_user  !== 'Yes' ,\n  'Household__c',\n  'CommCare_Code__c',\n  fields(\n    field('CommCare_Username__c', dataValue('properties.commcare_username')),\n    field('MOH_household_code__c', dataValue('properties.moh_code')),\n   field('CommCare_Code__c', dataValue('case_id')),\n    field('Source__c', true),\n    //field('Household_CHW__c', 'a030Q00000A0jeYQAR'), //sandbox hardcoded mapping\n field('Household_CHW__c', state => {\n      var chw = dataValue('properties.CHW_ID')(state);\n      return chw === 'a030800001zQrk'\n        ? 'a030800001zQrk5'\n        : chw\n        ? chw\n        : undefined;\n    }),\n   //TODO: Prod mapping to add back before go-live\n    field('Catchment__c', dataValue('catchmentNewId')),\n    field('Area__c', dataValue('areaNewId')),\n    field('Village__c', dataValue('villageNewId')),\n    field('Household_Village__c', dataValue('properties.village')),\n  //   relationship('Catchment__r', 'Name', state => {\n  //     var catchment =\n  //       state.data.properties.catchement ||\n  //       state.data.properties.catchment_name;\n  //     return catchment === '' || catchment === undefined\n  //       ? 'Unknown Location'\n  //       : catchment;\n  //   }), // check\n  //   field('Area__c', state => {\n  //    // var area = dataValue('properties.Area_Name')(state);\n  //     return area === '' || area === undefined ? 'a000Q00000Egmu4' : area;\n  //   }),  // Commented out because it was causing a job error \n  //   field('Household_village__c', dataValue('properties.village')),//case property, but not in message\n  \n  //   field('Village__c',dataValue('properties.village_name')), //lookup\n    field('Deaths_in_the_last_6_months__c', state => {\n      var death = dataValue(\n        'properties.deaths_in_past_6_months'\n      )(state);\n      return death > 0 ? 'Yes' : 'No';\n    }),\n    field('Access_to_safe_water__c',dataValue('properties.Safe_Water')),//not coming through\n    field('Treats_Drinking_Water__c',dataValue('properties.Treats_Drinking_Water')),//not coming through\n    field('Tippy_Tap__c',dataValue('properties.Active_Handwashing_Station')),//not coming through\n    field('Pit_Latrine__c',dataValue('properties.Functional_Latrine')),//not coming through\n    field('Rubbish_Pit__c',dataValue('properties.Rubbish_Pit')),//not coming through\n    field('Drying_Rack__c',dataValue('properties.Drying_Rack')),//not coming through\n    field('Kitchen_Garden__c',dataValue('properties.Kitchen_Garden')),//not coming through\n    field('Cookstove__c',dataValue('properties.Improved_Cooking_Method')),//not coming through\n    field('Clothe__c',dataValue('properties.Clothesline')),//not coming through\n    field('WASH_Trained__c',dataValue('properties.WASH_Trained')),//not coming through\n    field('Uses_ITNs__c',dataValue('properties.ITNs')),\n     field(\n      'Has_muac_tape__c',\n      dataValue('properties.family_muac_tape_available')\n    ),\n    //field('Total_household_people__c',dataValue('properties.Total_Number_of_Members')), //not coming through\n    field('Health_insurance__c', dataValue('properties.health_insurace_cover')),\n    field('Health_insurance_active_status__c',dataValue('properties.healthinsurance_active')),\n    field('Health_insurance_type__c', state => {\n      var status = dataValue('properties.health_insurance')(state);\n      return status && status === 'other_please_specify_if_active'\n        ? 'Other'\n        : status === 'nhif'\n        ? 'NHIF'\n        : status === 'Linda_mama' || 'linda_mama'\n        ? 'Linda mama'\n        : status;\n    }),\n    field('Other_Health_Insurance__c',dataValue('properties.if_other_please_specify')),\n    field('Work_with_TBA__c', dataValue('properties.tba')),\n    field('TBA_name__c', dataValue('properties.which_tba')),\n    field('Last_Modified_Date_CommCare__c', dataValue('server_date_modified')),//Need a case property),\n    field('Active_Household__c', state => {\n      var status = dataValue('properties.Household_Status')(state);\n      return status && status === 'No'\n        ? false\n        : status === 'Yes'\n        ? true\n        : status;\n    }),\n    // relationship('Head_of_Household__r', 'CommCare_ID__c', dataValue('properties.head_of_household_case_id')),\n     field('Inactive_Reason__c', state => {\n      var reason = dataValue('properties.Reason_for_Inactive')(state);\n      return reason ? reason.toString().replace(/_/g, ' ') : null;\n    }),\n     field(\n      'Active_in_Nutrition_Program__c',\n      dataValue(\n        'properties.enrolled_in_a_lwala_nutrition_program'\n      )\n    ),\n    field(\n      'lwala_nutrition_program_enrollment_date__c',\n      dataValue(\n        'properties.lwala_nutrition_program_enrollment_date'\n      )\n    ),\n    field(\n      'Trained_in_gardening__c',\n      dataValue('properties.household_trained_on_gardening')\n    ),\n    field(\n      'household_trained_on_gardening_date__c',\n      dataValue(\n        'properties.when_was_the_household_trained_on_gardening'\n      )\n    ),\n    field(\n      'Seed_Input_Support__c',\n      dataValue('properties.household_provided_with_seed_input_support'\n      )\n    ),\n    field(\n      'household_provided_with_seed_input_suppo__c',\n      dataValue(\n        'properties.when_was_the_household_provided_with_seed_input_support'\n      )\n    ),\n    field(\n      'MIYCN_Trained__c',\n      dataValue('properties.household_trained_on_MIYCN')\n    ),\n    // not in message:\n    // field(\n    //   'Kitchen_Garden__c',\n    //   dataValue('properties.nutrition_enrollment.household_has_kitchen_garden')\n    // ),\n\n    //field('Case_Closed_Date__c', state => {\n    //  var closed = dataValue('date_closed')(state); \n    //  var date =  dataValue('server_date_modified')(state); \n    //  return closed && closed == true ? date : undefined; \n   // })\n    )\n);\n\nfn(state => { console.log(\"upsertIf1 done\"); return state; });\nfn(state => {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      console.log('4 second cooldown finished.');\n      resolve(state);\n    }, 4000);\n  });\n});\n\n//Household Visit\nquery(\n  `SELECT Id, Parent_Geographic_Area__c, Parent_Geographic_Area__r.Name, Parent_Geographic_Area__r.Parent_Geographic_Area__c FROM Location__c WHERE CommCare_User_ID__c = '${dataValue(\n    'properties.owner_id'\n  )(state)}'`\n);\n\nfn(state => { console.log(\"query2 done\"); return state; });\nfn(state => {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      console.log('4 second cooldown finished.');\n      resolve(state);\n    }, 4000);\n  });\n});\n\nfn(state => ({\n  ...state,\n  data: {\n    ...state.data,\n    catchmentNewId:\n      state.references[0].records && state.references[0].records.length !== 0\n        ? (state.references[0].records[0].Parent_Geographic_Area__r \n          ? state.references[0].records[0].Parent_Geographic_Area__r.Parent_Geographic_Area__c\n          : undefined)\n        : undefined,\n  },\n}));\n\nfn(state => {\n/*  const deaths = state.data.form.household_deaths\n    ? state.data.form.household_deaths.deaths\n    : '';\n  if (deaths !== '' && !Array.isArray(deaths)) {\n    state.data.form.household_deaths.deaths = [deaths];\n  }*/\n\n  const supervisorMap = {\n    community_health_nurse: 'Community Health Nurse',\n    chw_supervisor: 'CHW Supervisor',\n    chewschas: 'CHEWs/CHAs',\n    other: 'Other',\n    none: 'None',\n  };\n\n  const insuranceMap = {\n    nhif: 'NHIF',\n    Linda_mama: 'Linda mama',\n    other_please_specify_if_active: 'Other',\n    none: 'None',\n  };\n\n  return { ...state, supervisorMap, insuranceMap };\n});\n\nupsertIf(\n  // state.data.properties.username !== 'openfn.test' &&\n    state.data.properties.username !== 'test.2021' &&\n    state.data.properties.test_user  !== 'Yes' ,\n  'Visit__c',\n  'CommCare_Visit_ID__c',\n  fields(\n    field('CommCare_Username__c', dataValue('properties.commcare_username')),//\n    // field('CommCare_Visit_ID__c', dataValue('id')),\n    field('CommCare_Visit_ID__c', state => {\n      var case_id = dataValue('case_id')(state);\n      var submitted = dataValue('properties.last_form_opened_date_and_time')(state);\n      return case_id + '_' +  submitted;\n    }),\n    // field('Household_CHW__c', 'a030Q00000A0jeY'),\n    // field('Catchment__c', dataValue('a000Q00000Egmtk')),\n    field('Catchment__c', dataValue('catchmentNewId')),\n    // field('Household__c','a010Q00000BL6lT'),\n    // field('Household__c', dataValue('form.case.@case_id')),\n    relationship(\n          'Household__r',\n          'CommCare_Code__c',\n          dataValue('case_id')),\n    field('Date__c',dataValue('properties.Date')),\n    field('Form_Submitted__c', dataValue('properties.last_form_opened_name')),\n\n    //field('MOH_household_code__c', state => {\n    //  var moh = dataValue('form.Household_Information.moh_code')(state);\n    //  var mohLinked = dataValue('form.MOH_household_code_linked')(state);\n    // return moh ? moh : mohLinked && mohLinked !== '' ? mohLinked : undefined;\n   // }),\n    field('Active_Household__c', state => {\n      var status = dataValue('properties.Household_Status')(state);\n      return status && status === 'No'\n        ? false\n        : status === 'Yes'\n        ? true\n        : status;\n    }),\n    //field('Inactive_Reason__c', state => {\n    //  var reason = dataValue('form.Reason_for_Inactive')(state);\n    //  return reason ? reason.toString().replace(/_/g, ' ') : null;\n    //}),\n    //field('Source__c', 1),//\n    //relationship(\n    //  'Household_CHW__r', \n    //  'CommCare_ID__c', \n    //  dataValue('form.sfid')),TO UPDATE IN PRODUCTION\n   // field('Household_village__c', dataValue('form.village')),//\n    //New Nutrition Field (MOTG)\n    field(\n      'Active_in_Nutrition_Program__c',\n      dataValue(\n        'properties.enrolled_in_a_lwala_nutrition_program'\n      )\n    ),\n    field(\n      'lwala_nutrition_program_enrollment_date__c',\n      dataValue(\n        'properties.lwala_nutrition_program_enrollment_date'\n      )\n    ),\n    field(\n      'Trained_in_gardening__c',\n      dataValue('properties.household_trained_on_gardening')\n    ),\n    field(\n      'household_trained_on_gardening_date__c',\n      dataValue(\n        'properties.when_was_the_household_trained_on_gardening'\n      )\n    ),\n    field(\n      'Seed_Input_Support__c',\n      dataValue(\n        'properties.household_provided_with_seed_input_support'\n      )\n    ),\n    field(\n      'household_provided_with_seed_input_suppo__c',\n      dataValue(\n        'properties.when_was_the_household_provided_with_seed_input_support'\n      )\n    ),\n    field(\n      'MIYCN_Trained__c',\n      dataValue('properties.household_trained_on_MIYCN')\n    ),\n    field(\n      'Kitchen_Garden__c',\n      dataValue('properties.Kitchen_Garden')\n    ),\n\n    field(\n      'Access_to_safe_water__c',\n      dataValue('properties.Safe_Water')\n    ),\n    field(\n      'Treats_Drinking_Water__c',\n      dataValue('properties.Treats_Drinking_Water')\n    ),\n    field(\n      'Tippy_Tap__c',\n      dataValue('properties.Active_Handwashing_Station')\n    ),\n    field(\n      'Pit_Latrine__c',\n      dataValue('properties.Functional_Latrine')\n    ),\n    field(\n      'Rubbish_Pit__c',\n      dataValue('properties.Rubbish_Pit')\n    ),\n    field(\n      'Drying_Rack__c',\n      dataValue('properties.Drying_Rack')\n    ),\n    field(\n      'Kitchen_Garden__c',\n      dataValue('properties.Kitchen_Garden')\n    ),\n    field(\n      'Cookstove__c',\n      dataValue('properties.Improved_Cooking_Method')\n    ),\n    field('Clothe__c', dataValue('properties.Clothesline')),\n    field(\n      'WASH_Trained__c',\n      dataValue('properties.WASH_Trained')\n    ),\n    field(\n      'Has_muac_tape__c',\n      dataValue('properties.family_muac_tape_available')\n    ),\n    field('Uses_ITNs__c', dataValue('properties.ITNs')),\n    field('Supervisor_Visit__c', state =>\n      state.data.properties.supervisor_visit\n        ? state.supervisorMap[state.data.properties.supervisor_visit]\n        : null\n    ),\n    field('Health_insurance__c', dataValue('properties.health_insurace_cover')),\n    field(\n      'Health_insurance_active_status__c',\n      dataValue('properties.healthinsurance_active')\n    ),\n    field('Health_insurance_type__c', state => {\n      var status = dataValue('properties.health_insurance')(state);\n      var value =\n        status && status !== ''\n          ? status\n              .replace(/ /gi, ';')\n              .split(';')\n              .map(value => {\n                return state.insuranceMap[value] || value;\n              })\n          : undefined;\n      return value ? value.join(';') : undefined;\n    }),\n    field(\n      'Other_Health_Insurance__c',\n      dataValue('properties.if_other_please_specify')\n    ),\n    //field('Last_Modified_Date_CommCare__c', dataValue('server_modified_on')),\n    field('CommCare_Form_Opened__c', state=> {\n      var form_opened = dataValue('properties.last_form_opened_date_and_time')(state);\n      var value1 = form_opened.split('-').slice(0, 2).join('-');\n      var value2 = form_opened.split('-').slice(2).join('-');\n      var formattedValue = [value1, value2].join(' ');\n      return new Date(formattedValue).toISOString();\n    }),\n    field('Case_Closed_Date__c', state => {\n      var closed = dataValue('date_closed')(state);\n      var date = dataValue('server_modified_on')(state);\n      return closed && closed == true ? date : undefined;\n    })\n  )\n);\n\nfn(state => { console.log(\"upsertIf2 done\"); return state; });\nfn(state => {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      console.log('Final 4 second cooldown finished.');\n      resolve(state);\n    }, 4000);\n  });\n});\n\n\n")))}p.isMDXComponent=!0},15680:(e,n,a)=>{a.d(n,{xA:()=>l,yg:()=>h});var t=a(96540);function r(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function o(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,t)}return a}function s(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?o(Object(a),!0).forEach((function(n){r(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function i(e,n){if(null==e)return{};var a,t,r=function(e,n){if(null==e)return{};var a,t,r={},o=Object.keys(e);for(t=0;t<o.length;t++)a=o[t],n.indexOf(a)>=0||(r[a]=e[a]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(t=0;t<o.length;t++)a=o[t],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var _=t.createContext({}),d=function(e){var n=t.useContext(_),a=n;return e&&(a="function"==typeof e?e(n):s(s({},n),e)),a},l=function(e){var n=d(e.components);return t.createElement(_.Provider,{value:n},e.children)},u="mdxType",p={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},c=t.forwardRef((function(e,n){var a=e.components,r=e.mdxType,o=e.originalType,_=e.parentName,l=i(e,["components","mdxType","originalType","parentName"]),u=d(a),c=r,h=u["".concat(_,".").concat(c)]||u[c]||p[c]||o;return a?t.createElement(h,s(s({ref:n},l),{},{components:a})):t.createElement(h,s({ref:n},l))}));function h(e,n){var a=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=a.length,s=new Array(o);s[0]=c;var i={};for(var _ in n)hasOwnProperty.call(n,_)&&(i[_]=n[_]);i.originalType=e,i[u]="string"==typeof e?e:r,s[1]=i;for(var d=2;d<o;d++)s[d]=a[d];return t.createElement.apply(null,s)}return t.createElement.apply(null,a)}c.displayName="MDXCreateElement"}}]);