"use strict";(self.webpackChunk_openfn_docs=self.webpackChunk_openfn_docs||[]).push([[46878],{28453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>r});var a=n(96540);const s={},o=a.createContext(s);function i(e){const t=a.useContext(o);return a.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),a.createElement(o.Provider,{value:t},e.children)}},47605:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/create_trigger-72300266a5f05029845bfaa1c77772f8.gif"},47689:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/activity_history_success-4bf88be6755cf5971a22c184fb9851de.png"},54825:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/create-new-workflow-fcc48e631f8d54dd06e72545ba5a9d34.gif"},56428:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/db_config-b22df6f0bbefc59968ed1f89559088b2.png"},60563:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/metabase-d197691432643693b52d5e5bb0b288db.png"},67813:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/cc-postgres-0e43a3ec2fd55882ec72a4c7103bb700.png"},79089:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/create_job_db-28c806e45bdfcaca64fe9205bd4d87a4.gif"},93419:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/option1-fce1d1c17260348267c6d93c42e93905.png"},94757:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/install_cc_app-a0db259c1350b908fcce5c2ab00d575a.png"},98687:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/postgresql-cred-b343dbf799802b766f489fcc213350af.gif"},98810:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/create-job-1802166d34fd4c970f131953ec9cdc7a.gif"},99006:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"tutorials/commcare-to-db","title":"Syncing your CommCare form submissions to a PostgreSQL database","description":"Before starting this tutorial please make sure:","source":"@site/docs/tutorials/commcare-to-db.md","sourceDirName":"tutorials","slug":"/tutorials/commcare-to-db","permalink":"/documentation/tutorials/commcare-to-db","draft":false,"unlisted":false,"editUrl":"https://github.com/openfn/docs/edit/main/docs/tutorials/commcare-to-db.md","tags":[],"version":"current","frontMatter":{"sidebar_label":"CommCare to PostgreSQL","title":"Syncing your CommCare form submissions to a PostgreSQL database"},"sidebar":"docs","previous":{"title":"Kobo to DHIS2","permalink":"/documentation/kobo-to-dhis2"},"next":{"title":"Design Process Overview","permalink":"/documentation/design/design-overview"}}');var s=n(74848),o=n(28453);const i={sidebar_label:"CommCare to PostgreSQL",title:"Syncing your CommCare form submissions to a PostgreSQL database"},r=void 0,d={},c=[{value:"Getting started",id:"getting-started",level:2},{value:"Getting data from CommCare",id:"getting-data-from-commcare",level:2},{value:"Option 1: Webhook to forward cases and/or forms in real-time from CommCare to OpenFn using REST service",id:"option-1-webhook-to-forward-cases-andor-forms-in-real-time-from-commcare-to-openfn-using-rest-service",level:3},{value:"Option 2: Extracting Commcare data via the REST API",id:"option-2-extracting-commcare-data-via-the-rest-api",level:3},{value:"Set up a workflow using Option 1",id:"set-up-a-workflow-using-option-1",level:3},{value:"Transforming and loading CommCare data to a PostgreSQL database",id:"transforming-and-loading-commcare-data-to-a-postgresql-database",level:2},{value:"Time to test!",id:"time-to-test",level:2}];function l(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"Before starting this tutorial please make sure:"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["You have signed up for ",(0,s.jsx)(t.a,{href:"http://openfn.org",children:"OpenFn.org"})," (it takes less than a\nminute!)"]}),"\n",(0,s.jsxs)(t.li,{children:["You have checked out our glossary and have an understanding of basic OpenFn\nand API terminology. Check out the pages below to get started","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"/documentation/get-started/terminology",children:"OpenFn Concepts"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"/documentation/get-started/glossary",children:"A glossary for data integration"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.li,{children:"You have a CommCare application with at least one form configured. This is\nyour source system."}),"\n",(0,s.jsx)(t.li,{children:"You have a PostgreSQL database configured. This is your destination system."}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"If you don\u2019t have a CommCare application or PostgreSQL database setup, you can\nalso follow along with the prebuilt solution. Follow along at the links below:"})}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://docs.google.com/spreadsheets/d/1pi_oxImakhtaCCCIENkjTPZeuyWhpFEcNmH7hfvTBgo/edit?usp=sharing",children:"Mapping specifications document"})}),"\n",(0,s.jsxs)(t.li,{children:["Commcare application to download:","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Username: testuser"}),"\n",(0,s.jsx)(t.li,{children:"Password: 123"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"install_cc_app",src:n(94757).A+"",width:"852",height:"466"})}),"\n",(0,s.jsxs)(t.ol,{start:"3",children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://analytics.openfn.org/public/question/095449a9-5696-463c-a4fb-24614c9f08a5",children:"Public report that shows records in the PostgreSQL database"})}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"getting-started",children:"Getting started"}),"\n",(0,s.jsxs)(t.p,{children:["In this walkthrough, we will be setting up an ",(0,s.jsx)(t.strong,{children:"automatic data sync between\nCommCare and a PostgreSQL database"}),". We will be syncing submissions coming from\na CommCare ",(0,s.jsx)(t.code,{children:"Maternal and Newborn Health"})," application that has a\n",(0,s.jsx)(t.code,{children:"Register a New Patient"})," form."]}),"\n",(0,s.jsx)(t.admonition,{type:"tip",children:(0,s.jsx)(t.p,{children:"Whenever a CommCare user registers a new patient, the patient details will\nautomatically be synced to an already configured PostgreSQL database to enable\nreal-time monitoring and analytics on data collected in the field. For example,\nthis database can quickly be connected to a dashboard that collects aggregate\ndata on patients registered!"})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"cc-postgres",src:n(67813).A+"",width:"1144",height:"246"})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"This integration can be broken up into two parts:"})}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Getting data from your source system into OpenFn to trigger your workflow"}),"\n",(0,s.jsx)(t.li,{children:"Transforming and loading this data to your destination system"}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"\u2026 let\u2019s get started!"}),"\n",(0,s.jsx)(t.h2,{id:"getting-data-from-commcare",children:"Getting data from CommCare"}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"There are two ways to get your CommCare form submissions in OpenFn."})}),"\n",(0,s.jsx)(t.h3,{id:"option-1-webhook-to-forward-cases-andor-forms-in-real-time-from-commcare-to-openfn-using-rest-service",children:"Option 1: Webhook to forward cases and/or forms in real-time from CommCare to OpenFn using REST service"}),"\n",(0,s.jsxs)(t.p,{children:["CommCareHQ has a native data forwarding feature that provides a webhook/REST\nservice that can be pointed to the destination of your choice (i.e., your OpenFn\nworkflow). When a webhook is configured, any Commcare forms submitted are\n",(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.em,{children:"automatically forwarded"})})," to the designated endpoint, such as your OpenFn\nworkflow. After data forwarding is set up, it happens automatically, ",(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.em,{children:"in\nreal-time for all forms and cases"})}),". Learn more about configuring a webhook\n",(0,s.jsx)(t.a,{href:"/adaptors/commcare#webhook-forward-cases-andor-forms-from-commcare-to-openfn-using-rest-service",children:"here"}),"."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"option1",src:n(93419).A+"",width:"1132",height:"572"})}),"\n",(0,s.jsx)(t.h3,{id:"option-2-extracting-commcare-data-via-the-rest-api",children:"Option 2: Extracting Commcare data via the REST API"}),"\n",(0,s.jsxs)(t.p,{children:["CommCare provides a robust\n",(0,s.jsx)(t.a,{href:"https://confluence.dimagi.com/display/commcarepublic/List+Forms",children:"REST API"})," for\nextracting and loading data. This second option involves configuring a step in\nOpenFn to fetch CommCare submissions via a ",(0,s.jsx)(t.code,{children:"GET"})," HTTP request with parameters to\nfilter your data query. CommCare API access requires a paid CommCare plan."]}),"\n",(0,s.jsx)(t.p,{children:"The main advantage of using the webhook is that your data is forwarded to the\ndestination system in real-time. However, the List Forms API is also\nadvantageous because it enables users to extract data in bulk on a scheduled\nbasis, for syncing historical data every month on the 30th, for example.\nDeciding on which option to go with depends on your business requirements."}),"\n",(0,s.jsx)(t.h3,{id:"set-up-a-workflow-using-option-1",children:"Set up a workflow using Option 1"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.strong,{children:"Open up an existing project and create a new workflow"})}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"create_new_workflow",src:n(54825).A+"",width:"1434",height:"672"})}),"\n",(0,s.jsxs)(t.ol,{start:"2",children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.strong,{children:"Create a new \u201cWebhook\u201d trigger to schedule this extract job."})}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"create_trigger",src:n(47605).A+"",width:"1432",height:"672"})}),"\n",(0,s.jsx)(t.p,{children:"Make sure you have copied the webhook URL from your OpenFn workflow into CommCare. Each form submitted in CommCare will be automatically sent to OpenFn and will trigger your new workflow."}),"\n",(0,s.jsx)(t.h2,{id:"transforming-and-loading-commcare-data-to-a-postgresql-database",children:"Transforming and loading CommCare data to a PostgreSQL database"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"You should have a database configured and a username provided for OpenFn to\nread and write data in your target DB tables."})," For this demo, we have\nconfigured the database\n",(0,s.jsx)(t.a,{href:"https://docs.google.com/spreadsheets/d/1pi_oxImakhtaCCCIENkjTPZeuyWhpFEcNmH7hfvTBgo/edit?usp=sharing",children:"like this"}),"\nto capture the CommCare form data. Check out the\n",(0,s.jsx)(t.a,{href:"../design/mapping-specs",children:"this page"}),"\nfor how to create your own ",(0,s.jsx)(t.code,{children:"mapping specification document"})," to map data\nelements to be exchanged."]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"db_config",src:n(56428).A+"",width:"1122",height:"564"})}),"\n",(0,s.jsxs)(t.ol,{start:"2",children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsxs)(t.strong,{children:["Create a new step with the ",(0,s.jsx)(t.code,{children:"postgresql"})," adaptor for loading the CommCare\ndata into your destination database."]})}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"configure_job_postgres",src:n(98810).A+"",width:"1434",height:"672"})}),"\n",(0,s.jsxs)(t.ol,{start:"3",children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.strong,{children:"Create a PostgreSQL credential which will be used by the step to\nauthenticate with the database."})}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"add_credential_postgres",src:n(98687).A+"",width:"1440",height:"672"})}),"\n",(0,s.jsxs)(t.ol,{start:"4",children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Writing the step:"})," For this step we will use the upsert operation to\ninsert/update records in the destination ",(0,s.jsx)(t.code,{children:"patient"})," table and use ",(0,s.jsx)(t.code,{children:"patient_id"})," as\nthe primary key. An ",(0,s.jsx)(t.code,{children:"upsert"})," will update an existing row if a specified value\nalready exists in a table, and insert a new row if the specified value doesn't\nalready exist."]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"upsert('patient', 'ON CONSTRAINT patient_pk', {\n  patient_id: dataValue('data.patient_name'),\n  patient_name: dataValue('data.patient_name'),\n  village_name: dataValue('data.village_name'),\n  last_menstrual_period: dataValue('data.last_menstrual_period'),\n  expected_delivery_date: dataValue('data.expected_delivery_date'),\n  children_alive: dataValue('data.children_alive'),\n  living_children: dataValue('data.living_children'),\n  feeling_sick: dataValue('data.feeling_sick'),\n  total_children: dataValue('data.Total_children'),\n  risk_level: dataValue('data.Risk_level'),\n});\n"})}),"\n",(0,s.jsx)(t.p,{children:"Feel free to modify the code above to reflect your CommCare and database\nconfiguration according to your mapping specifications."}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"create-job",src:n(79089).A+"",width:"1440",height:"672"})}),"\n",(0,s.jsx)(t.h2,{id:"time-to-test",children:"Time to test!"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Submit a form in CommCare"}),"\n",(0,s.jsx)(t.li,{children:"If you have enabled data forwarding, your workflow should should be triggered automatically."}),"\n",(0,s.jsxs)(t.li,{children:["If you have not enabled data forwarding and set up a FETCH step instead, run\nthe step (ensure the ",(0,s.jsx)(t.code,{children:"received_on_start"})," and ",(0,s.jsx)(t.code,{children:"received_on_start"})," dates in the\nFETCH are appropriate)."]}),"\n",(0,s.jsx)(t.li,{children:"Run the FETCH step. If the fetch step passes, the \u201cLoad to DB\u201d step should\nautomatically run."}),"\n",(0,s.jsxs)(t.li,{children:["Check out the ",(0,s.jsx)(t.code,{children:"History"})," and ensure that the work order was successful."]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"activity_history_final",src:n(47689).A+"",width:"2878",height:"1000"})}),"\n",(0,s.jsxs)(t.admonition,{type:"info",children:[(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"What do do if your run fails:"})}),(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Open the run to inspect the error log"}),"\n",(0,s.jsxs)(t.li,{children:['Adjust the step to resolve the issue and re-run the step as needed by clicking the\n"rerun" button in ',(0,s.jsx)(t.code,{children:"History"}),' or the "Re-run from here" button on the ',(0,s.jsx)(t.code,{children:"Inspector"})]}),"\n",(0,s.jsxs)(t.li,{children:["Check out the ",(0,s.jsx)(t.a,{href:"/adaptors/postgresql/#common-errors",children:"PostgreSQL common errors"}),"\npage for more details!"]}),"\n"]})]}),"\n",(0,s.jsxs)(t.ol,{start:"4",children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.strong,{children:"Finally, refresh your database and check out the new submission data!"})}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"metabase",src:n(60563).A+"",width:"2826",height:"260"})}),"\n",(0,s.jsx)(t.p,{children:"While this guide is specifically for PostgreSQL databases, you can generally\nfollow these same steps for other database types (e.g., MS SQL or MySQL)\u2014simply\nleverage a different adaptor in your step configuration."}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"Other resources to check out:"})}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"OpenFn Job Library"}),"\n",(0,s.jsx)(t.li,{children:"OpenFn Docs \u2018App\u2019 pages for CommCare and Postgres"}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsxs)(t.strong,{children:["Any questions? Comments? New configuration ideas? Please reach out to us with\na post on the ",(0,s.jsx)(t.a,{href:"https://community.openfn.org/",children:"OpenFn Community"})," forum."]})})]})}function h(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}}}]);