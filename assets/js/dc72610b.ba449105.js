"use strict";(self.webpackChunk_openfn_docs=self.webpackChunk_openfn_docs||[]).push([[43514],{8015:(e,t,n)=>{n.d(t,{A:()=>a});const a="data:image/webp;base64,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"},28453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>r});var a=n(96540);const s={},o=a.createContext(s);function i(e){const t=a.useContext(o);return a.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),a.createElement(o.Provider,{value:t},e.children)}},94813:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"jobs/job-writing-guide","title":"Job Writing Guide","description":"Workflow automation and data integration in OpenFn is realised through the","source":"@site/docs/jobs/job-writing-guide.md","sourceDirName":"jobs","slug":"/jobs/job-writing-guide","permalink":"/documentation/jobs/job-writing-guide","draft":false,"unlisted":false,"editUrl":"https://github.com/openfn/docs/edit/main/docs/jobs/job-writing-guide.md","tags":[],"version":"current","frontMatter":{"sidebar_label":"Job Writing Guide","title":"Job Writing Guide"},"sidebar":"docs","previous":{"title":"Workflow Specifications","permalink":"/documentation/design/workflow-specs"},"next":{"title":"Input and output state","permalink":"/documentation/jobs/state"}}');var s=n(74848),o=n(28453);const i={sidebar_label:"Job Writing Guide",title:"Job Writing Guide"},r=void 0,l={},c=[{value:"Operations and State",id:"operations-and-state",level:2},{value:"Callbacks and fn()",id:"callbacks-and-fn",level:2},{value:"Operations run at the top level",id:"operations-run-at-the-top-level",level:2},{value:"Reading state lazily",id:"reading-state-lazily",level:2},{value:"The Lazy State Operator",id:"the-lazy-state-operator",level:2},{value:"Usage Examples",id:"usage-examples",level:3},{value:"$ is not state",id:"-is-not-state",level:3},{value:"Operations and Promises",id:"operations-and-promises",level:2},{value:"Callback with then()",id:"callback-with-then",level:3},{value:"Error handling with catch()",id:"error-handling-with-catch",level:3},{value:"Mapping Objects",id:"mapping-objects",level:2},{value:"Iteration with each()",id:"iteration-with-each",level:2},{value:"Variable initialisation",id:"variable-initialisation",level:2},{value:"Using Cursors",id:"using-cursors",level:2},{value:"Setting the cursor value",id:"setting-the-cursor-value",level:3},{value:"Using the cursor",id:"using-the-cursor",level:3},{value:"Manual Cursors",id:"manual-cursors",level:3},{value:"Cursor Options",id:"cursor-options",level:3},{value:"Formatting the value",id:"formatting-the-value",level:3},{value:"Cleaning final state",id:"cleaning-final-state",level:2},{value:"Referencing credential secrets in your job code",id:"referencing-credential-secrets-in-your-job-code",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Compilation",id:"compilation",level:2},{value:"Next Steps",id:"next-steps",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components},{Details:a}=t;return a||function(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.p,{children:"Workflow automation and data integration in OpenFn is realised through the\ncreation of Jobs."}),"\n",(0,s.jsx)(t.p,{children:"This guide will walk you through key concepts and best practices for job\nwriting. It is suitable for new coders and experienced JavaScript programmers.\nIn fact, even if you're an experienced JavaScript developer, there are a number\nof key patterns in the OpenFn ecosystem which it is important to learn."}),"\n",(0,s.jsx)(t.admonition,{type:"tip",children:(0,s.jsxs)(t.p,{children:["If you're writing jobs on the platform app (Lightning), you can use the ",(0,s.jsx)(t.a,{href:"/documentation/build/ai-assistant",children:"AI Assistant"})," to help you. You'll find it in the Inspector."]})}),"\n",(0,s.jsx)(t.p,{children:"A Job is a bunch of JavaScript code which performs a particular task, like\nfetching data from Salesforce or converting some JSON data to FHIR standard."}),"\n",(0,s.jsx)(t.p,{children:'Each job uses exactly one Adaptor (often called a "connector") to perform its\ntask. The Adaptor provides a collection of helper functions (Operations) which\nmakes it easy to communicate with a data source.'}),"\n",(0,s.jsx)(t.p,{children:"This guide applies equally to writing Jobs on the app (Lightning) or through the\nCLI."}),"\n",(0,s.jsxs)(t.admonition,{title:"Workflows",type:"info",children:[(0,s.jsx)(t.p,{children:"Multiple jobs can be chained together in a Workflow. A common pattern is to use\none job to fetch data from datasource A, one job to convert or transform that\ndata to be compatible with datasource B, and a third job to upload the\ntransformed data to datasource B."}),(0,s.jsxs)(t.p,{children:["To learn more about workflow design and implementation, see\n",(0,s.jsx)(t.a,{href:"/documentation/build/workflows",children:"Build & Manage Workflows"})]})]}),"\n",(0,s.jsx)(t.h2,{id:"operations-and-state",children:"Operations and State"}),"\n",(0,s.jsx)(t.p,{children:"Every job is a data transformation pipeline."}),"\n",(0,s.jsx)(t.p,{children:"It takes some input (a JavaScript object we call State) and executes a set of\nOperations (or functions), which transform that state in series (ie, one after\nthe other). The final state object is returned as the output of the pipeline."}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Job Pipeline",src:n(8015).A+"",width:"1017",height:"372"})}),"\n",(0,s.jsxs)(t.p,{children:["Operations are provided by an Adaptor (connector). Each adaptor exports a list\nof functions designed to interact with a particular data source - for example,\ntake a look at the ",(0,s.jsx)(t.a,{href:"/adaptors/packages/dhis2-docs",children:"dhis2"})," and\n",(0,s.jsx)(t.a,{href:"/adaptors/packages/salesforce-docs",children:"salesforce"})," adaptors."]}),"\n",(0,s.jsx)(t.p,{children:"Everything you can achieve in OpenFn can be achieve with existing JavaScript\nlibraries or calls to REST APIs. The value of Adaptors is that they provide\nfunctions to make this stuff easier: taking care of authorisation, providing\ncleaner syntax, and hiding away implementation details for you."}),"\n",(0,s.jsx)(t.p,{children:"For example, here's how simply we issue a GET request with the http adaptor:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get('/patients');\n"})}),"\n",(0,s.jsxs)(t.p,{children:["The first argument to ",(0,s.jsx)(t.code,{children:"get"})," is the path to request from (the configuration will\ntell the adaptor what base url to use). In this case we're passing a static\nstring, but we can also pass a value from state:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get(state => state.endpoint);\n"})}),"\n",(0,s.jsxs)(a,{children:[(0,s.jsxs)(t.p,{children:[(0,s.jsx)("summary",{children:"Why the arrow function?"}),"\nIf you've got some JavaScript experience, you'll notice the example above uses an arrow function to retrieve the endpoint key from state."]}),(0,s.jsx)(t.p,{children:"But why not just do this?"}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"get(state.endpoint);\n"})}),(0,s.jsx)(t.p,{children:"Well, the problem is that the state value must be resolved lazily (ie, just\nbefore the get actually runs). Because of how Javascript works, if we just\ninline the value it might read before state.endpoint has been actually been\nassigned."}),(0,s.jsxs)(t.p,{children:["For more details, jump ahead to ",(0,s.jsx)(t.a,{href:"#reading-state-lazily",children:"Reading State Lazily"})]})]}),"\n",(0,s.jsx)(t.p,{children:"Your job code should only contain Operations at the top level/scope - you should\nNOT include any other JavaScript statements. We'll talk about this more in a\nminute."}),"\n",(0,s.jsx)(t.h2,{id:"callbacks-and-fn",children:"Callbacks and fn()"}),"\n",(0,s.jsx)(t.admonition,{type:"caution",children:(0,s.jsxs)(t.p,{children:["As of July 2024, callbacks are going to be phased out of the adaptor APIs. See\n",(0,s.jsx)(t.a,{href:"#promise-like-operations",children:"Promise-like Operations"})," for tips on how to use\ncallbacks with adaptors APIs that don't explicitly support them."]})}),"\n",(0,s.jsx)(t.p,{children:"Many Operations give you access to a callback function."}),"\n",(0,s.jsx)(t.p,{children:"Callbacks will be invoked with state, will run whatever code you like, and must\nreturn the next state. Usually your callback will be invoked as the very last\nstep in an operation."}),"\n",(0,s.jsx)(t.p,{children:"This is useful for intercepting and manipulating the return value of a given\noperation."}),"\n",(0,s.jsxs)(a,{children:[(0,s.jsxs)(t.p,{children:[(0,s.jsx)("summary",{children:"What is a callback?"}),"\nA callback is a common pattern in JavaScript."]}),(0,s.jsx)(t.p,{children:"It's kind of hard to understand in the abstract: a callback is a function which\nyou pass into some other function, to be invoked by that function at a\nparticular time."}),(0,s.jsxs)(t.p,{children:["It's best explained with an example. All JavaScript arrays have a function\ncalled ",(0,s.jsx)(t.code,{children:"map"}),", which takes a single callback argument."]}),(0,s.jsx)(t.p,{children:"Array.map will iterate over every item in the array, invoke your callback\nfunction with it, save the result to a new array, and when it's finished, it\nwill return that array."}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"const array = ['a', 'b', 'c'];\nconst result = array.map(item => {\n  return item.toUpperCase();\n});\nconsole.log(array); // ['a', 'b', 'c'];\nconsole.log(result); // ['A', 'B', 'C'];\n"})}),(0,s.jsx)(t.p,{children:"Because functions are data in JavaScript, we can we-write that code like this\n(which might be a bit more readable)"}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"const array = ['a', 'b', 'c'];\nconst upperCase = item => {\n  return item.toUpperCase();\n};\nconst result = array.map(upperCase);\nconsole.log(array); // ['a', 'b', 'c'];\nconsole.log(result); // ['A', 'B', 'C'];\n"})})]}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"fn()"})," function, for example, ONLY allows you define a callback. This is\nuseful for running arbitrary code - if you want to drop down to raw JavaScript\nmode, this is how you do it:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"fn(state => {\n  // declare a help function\n  const convertToFhir = item => {\n    /* ... */\n  };\n\n  // Map data into a new format with native Javascript functions\n  state.transformed = state.data.map(convertToFhir);\n\n  // Always return the state\n  return state;\n});\n"})}),"\n",(0,s.jsx)(t.p,{children:"Many other operations provide a callback argument, in which case, your callback\nwill be invoked with state, and most return the final state as a result of the\noperation."}),"\n",(0,s.jsx)(t.p,{children:"For example, say you fetch some data from a data source and get back a block of\nJSON. Maybe you want to filter this data before passing it to the next\noperation."}),"\n",(0,s.jsx)(t.p,{children:"You might naively try something like this - but it won't work!"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get('/data'); // writes to state.data\nstate.data = state.data.filter(/* ... */); // This is invalid!\n"})}),"\n",(0,s.jsxs)(t.p,{children:["You could use another operation, like ",(0,s.jsx)(t.code,{children:"fn"})," or ",(0,s.jsx)(t.code,{children:"each"})," - and often these work\ngreat!"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get('/data');\nfn(state => {\n  state.data = state.data.filter(/* ... */);\n  return state;\n});\n"})}),"\n",(0,s.jsx)(t.p,{children:"But you can also use a callback function, which is usually a bit neater:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get('/data', {}, state => {\n  state.data = state.data.filter(/* ... */);\n  return state;\n});\n"})}),"\n",(0,s.jsx)(t.p,{children:"Whatever your callback returns will be used as the input state for the next\noperation (or will be the final state for the job). So remember to ALWAYS return\nstate!"}),"\n",(0,s.jsxs)(t.p,{children:["Be mindful that some Adaptors will write internal information to state. So you\nshould usually ",(0,s.jsx)(t.code,{children:"return { ... state }"})," rather than ",(0,s.jsx)(t.code,{children:"return { data: state.data }"}),"."]}),"\n",(0,s.jsx)(t.admonition,{type:"tip",children:(0,s.jsx)(t.p,{children:"Remember! Always return state from a callback."})}),"\n",(0,s.jsx)(t.h2,{id:"operations-run-at-the-top-level",children:"Operations run at the top level"}),"\n",(0,s.jsx)(t.p,{children:"Operations will only work when they are at the top level of your job code, like\nthis:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get('/patients');\neach('$.data.patients[*]', state => {\n  item.id = `item-${index}`;\n  return state;\n});\npost('/patients', dataValue('patients'));\n"})}),"\n",(0,s.jsx)(t.p,{children:"OpenFn will call your operations in series during workflow execution, ensuring\nthe correct state is fed into each one."}),"\n",(0,s.jsx)(t.p,{children:"If you try to nest an operation inside the callback of another operation, you'll\nquickly run into trouble:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get('/patients', { headers: { 'content-type': 'application/json' } }, state => {\n  // This will fail because it is nested in a callback\n  each('$.data.patients[*]', (item, index) => {\n    item.id = `item-${index}`;\n  });\n});\npost('/patients', dataValue('patients'));\n"})}),"\n",(0,s.jsx)(t.p,{children:'This is because an operation is actually a "factory" style function - when\nexecuted, it returns a new function. That new function must be invoked with\nstate, and will return state.'}),"\n",(0,s.jsxs)(a,{children:[(0,s.jsxs)(t.p,{children:[(0,s.jsx)("summary",{children:"What is a factory function?"}),"\nFactory functions are can be a difficult pattern to understand deeply. However, like many programming concepts, it makes more sense after some hands-on experience. Luckily, you don't need to deeply understand the pattern to understand OpenFn."]}),(0,s.jsx)(t.p,{children:"Simply put, a factory function doesn't really do anything when executed. It\nsimply returns a function to do something later."}),(0,s.jsx)(t.p,{children:"Factory functions are useful for deferred execution (declaring behaviour NOW to\nrun LATER), lazy loading (fetching data from a server at the last moment, just\nbefore you need it), constructor functions (for instantiating classes into\nobjects), and scope binding (for trapping local variables in a scope and\nre-using them later)."}),(0,s.jsx)(t.p,{children:"They're used in OpenFn for deferred execution. Our runtime converts each factory\ninto an actual function, saves all the functions into an array, and calls them\nsequentially, passing in the latest state object to each one."})]}),"\n",(0,s.jsx)(t.p,{children:"The OpenFn runtime knows how to handle an operation at the top scope, it can run\nit as part of the pipeline and handle state appropriately. However, the runtime\ndoes not know how to deal with a nested operation like above."}),"\n",(0,s.jsx)(t.p,{children:"Best practices dictate you should build each discrete operation of the pipeline\nat the top-level, passing state between them naturally via the pipeline. This\nmeans you should never need to nest an operation. However, if you ever find\nyourself in a situation where you absolutely need to use a nested operation, you\nshould pass state into it directly, for example:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get('/patients', { headers: { 'content-type': 'application/json' } }, state => {\n  each('$.data.patients[*]', (item, index) => {\n    item.id = `item-${index}`;\n  })(state); // Immediately invoke the Operation and pass state into it. This is naughty!\n});\npost('/patients', dataValue('patients'));\n"})}),"\n",(0,s.jsx)(t.p,{children:"To be clear, this is considered an anti-pattern and should not be used except in\nemergencies."}),"\n",(0,s.jsx)(t.h2,{id:"reading-state-lazily",children:"Reading state lazily"}),"\n",(0,s.jsx)(t.p,{children:"A common problem in OpenFn coding is getting hold of the right state value at\nthe right time."}),"\n",(0,s.jsx)(t.p,{children:"Consider this code:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get('/some-data');\npost('/some-other-data', state.data);\n"})}),"\n",(0,s.jsxs)(t.p,{children:["The code attempts to call the GET method on some REST API service, save the\nresult to ",(0,s.jsx)(t.code,{children:"state.data"}),", and then pass that ",(0,s.jsx)(t.code,{children:"state.data"})," value into a post call\nto send it somewhere else."]}),"\n",(0,s.jsx)(t.p,{children:"Can you see the problem?"}),"\n",(0,s.jsxs)(t.p,{children:["The value of ",(0,s.jsx)(t.code,{children:"state.data"})," in the post call will resolve to ",(0,s.jsx)(t.code,{children:"undefined"})," and so\nthe post will fail."]}),"\n",(0,s.jsxs)(t.p,{children:["This is because Operations are\n",(0,s.jsx)(t.a,{href:"#operations-run-at-the-top-level",children:"factory functions"})," (See:\n",(0,s.jsx)(t.code,{children:"What is a factory function?"})," above). They declare behaviour to be executed\nlater, and provide parameters to calibrate that behaviour. But they don't\nactually go off and do the work immediately."]}),"\n",(0,s.jsxs)(t.p,{children:["Those parameters will be resolved to values when the module loads (load-time),\nbefore any code has run (run-time), and before ",(0,s.jsx)(t.code,{children:"state.data"})," has been assigned a\nvalue."]}),"\n",(0,s.jsxs)(a,{children:[(0,s.jsxs)(t.p,{children:[(0,s.jsx)("summary",{children:"More details about job execution and parameter resolution"}),"\nLet's try to explain a bit more about what's happening."]}),(0,s.jsx)(t.p,{children:"When your job runs, it will be evaluated in a Javascript engine and follow the\nusual rules of Javsacript. That is to say: each statement will be executed in\nsequence (forget about asynchronous functions for a moment!)."}),(0,s.jsxs)(t.p,{children:["The first statement, ",(0,s.jsx)(t.code,{children:"get('/some-data)"}),", calls OpenFn's ",(0,s.jsx)(t.code,{children:"get"})," function and\npasses it a string. ",(0,s.jsx)(t.code,{children:"get"})," then returns another function which will be executed\nlater."]}),(0,s.jsxs)(t.p,{children:["The second statement, ",(0,s.jsx)(t.code,{children:"post('/some-other-data', state.data)"})," does something\nsimilar. It calls the ",(0,s.jsx)(t.code,{children:"post"})," function, passing in a string and whatever sits on\n",(0,s.jsx)(t.code,{children:"state.data"}),", and returns a function to be executed later. But the two arguments\nhave already been resolved to values."]}),(0,s.jsx)(t.p,{children:"Calling an operation is a bit like declaring a contract: you specify what you\nwant to happen, and in what order, and what the terms of the contact are. Then\nOpenFn will go off and fulfill the terms of that contract for you."}),(0,s.jsxs)(t.p,{children:["The problem is that when you specify the terms of the contract, you don't have\nall the values to hand. We don't know what ",(0,s.jsx)(t.code,{children:"state.data"}),' is yet. So we need to\nsay "WHEN you run this function, check the value of ',(0,s.jsx)(t.code,{children:"state.data"}),', and use\nwhatever it says".']}),(0,s.jsxs)(t.p,{children:['"WHEN you run this function" is the key portion: how do we ensure that the value\nof ',(0,s.jsx)(t.code,{children:"state.data"})," is resolved at the right time? JavaScript itself isn't built to\ndo that - it'll just return the value when we read it (and remember, we read it\nat load-time, not at run-time)."]}),(0,s.jsx)(t.p,{children:"There are two good JavaScript-y solutions to the problem:"}),(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Pass a string which represents a path on state, and resolve that path inside\nthe actual function when it runs."}),"\n",(0,s.jsx)(t.li,{children:"Pass a function (or a Promise) which returns some value from state, and call\nthat function inside the actual function when it runs."}),"\n"]}),(0,s.jsxs)(t.p,{children:["Mostly our adaptors support the second pattern. In fact, if you look in some of\nour\n",(0,s.jsx)(t.a,{href:"https://github.com/OpenFn/adaptors/blob/1fdca7d130146a0c7acbb870ec2902d6e8063dc2/packages/mailchimp/src/Adaptor.js#L357",children:"adaptor source code"}),',\nyou\'ll see that the first thing we do is to "expand references" - that means\nlook at the arguments, see if any of them are functions (or contain) functions,\nand "expand" them by calling the functions and saving out the values.']}),(0,s.jsx)(t.p,{children:"This whole Lazy State discussion is about defining a bunch of behaviours NOW,\nbut reading data values LATER."})]}),"\n",(0,s.jsxs)(t.p,{children:["In other words, by the time the post operation is created and we read from\n",(0,s.jsx)(t.code,{children:"state.data"}),", all we've done is ",(0,s.jsx)(t.em,{children:"create"})," the ",(0,s.jsx)(t.code,{children:"get"})," function - we haven't\nactually ",(0,s.jsx)(t.em,{children:"run"})," it."]}),"\n",(0,s.jsxs)(t.p,{children:["What we need to do is ",(0,s.jsx)(t.em,{children:"defer"})," the evaluation of ",(0,s.jsx)(t.code,{children:"state.data"})," until the ",(0,s.jsx)(t.code,{children:"get"}),"\nfunction has finished and the ",(0,s.jsx)(t.code,{children:"post"})," operation actually runs."]}),"\n",(0,s.jsxs)(t.p,{children:["There are a few ways we can do that (including the new\n",(0,s.jsx)(t.a,{href:"#the-lazy-state-operator",children:"Lazy State operator"}),", see below). Some jobs use\n",(0,s.jsx)(t.code,{children:"dataValue"}),", which is neat if a bit verbose (there are many examples in this\nguide), and some operations support JSON path strings. The preferred way in\nmodern OpenFn is to use an inline-function:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get('/some-data');\npost('/some-other-data', (state) => state.data);\n"})}),"\n",(0,s.jsxs)(t.p,{children:["This passes a ",(0,s.jsx)(t.em,{children:"function"})," into the ",(0,s.jsx)(t.code,{children:"post"})," operator, instead of a value"]}),"\n",(0,s.jsxs)(t.p,{children:["When the ",(0,s.jsx)(t.code,{children:"post()"})," call actually executes, the first thing it'll do is resolve\nany function into arguments into values. It does this by calling the function,\npassing in the latest state, and using the return as the value."]}),"\n",(0,s.jsx)(t.p,{children:"These lazy functions are incredibly powerful. Using them effectively is the key\nto writing good OpenFn jobs."}),"\n",(0,s.jsx)(t.h2,{id:"the-lazy-state-operator",children:"The Lazy State Operator"}),"\n",(0,s.jsxs)(t.admonition,{title:"Experimental Feature",type:"tip",children:[(0,s.jsx)(t.p,{children:"The Lazy State operator is new to OpenFn as of April 2024. It is still\nconsidered an experimental feature. But it works great, and we encourage you to\nuse it!"}),(0,s.jsxs)(t.p,{children:["If you've got any feedback, issues or suggestions around the Lazy State\nOperator, we'd love to hear from you on\n",(0,s.jsx)(t.a,{href:"https://community.openfn.org",children:"Community"}),"! Or you can raise an issue on\n",(0,s.jsx)(t.a,{href:"https://github.com/openfn/kit/issues",children:"GitHub"}),"."]})]}),"\n",(0,s.jsx)(t.p,{children:"The Lazy State Operator is a shorthand syntax that makes it easier to read state\nwhen passing data into an operation."}),"\n",(0,s.jsxs)(t.p,{children:["Instead of writing ",(0,s.jsx)(t.code,{children:"state.data"})," to access something on state, you can use ",(0,s.jsx)(t.code,{children:"$"}),",\nlike this:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get($.data.url);\n"})}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"$"})," ensures that the value passed to the operation will be resolved at the\ncorrect time. Think of it like passing a path to some part of state, rather than\npassing the value of that path."]}),"\n",(0,s.jsxs)(t.p,{children:["What's nice about this is that you can basically ignore the previous section\nentirely and not think too much about state evaluation. Just read from ",(0,s.jsx)(t.code,{children:"$"})," like\nyour state object and the OpenFn runtime will resolve the value correctly at\nrun-time."]}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"$"})," symbol is really just syntactic sugar for ",(0,s.jsx)(t.code,{children:"(state) => state"})," (in most\ncases, we just do a string replace when compiling your code). These two\nstatements behave in exactly the same way:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get($.data.url);\nget((state) => state.data.url);\n"})}),"\n",(0,s.jsxs)(t.p,{children:['We call it "lazy state" because the reference will be resolved by the runtime\nengine immediately before its used. This bypasses a lot of the asynchronicity\nproblems of Javascript which are discussed in\n',(0,s.jsx)(t.a,{href:"#reading-state-lazily",children:"Reading State Lazily"}),"."]}),"\n",(0,s.jsx)(t.admonition,{title:"$ Only works within Operations",type:"tip",children:(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.code,{children:"$"})," only works when used inside an expression that's passed to an operation. In\nother words, you can only use it when you could write ",(0,s.jsx)(t.code,{children:"(state) => state"})," instead\n(like the example above)."]})}),"\n",(0,s.jsx)(t.h3,{id:"usage-examples",children:"Usage Examples"}),"\n",(0,s.jsxs)(t.p,{children:["The following short code snippets show some examples of how the Lazy State\nOperator can be used. Each example can be re-written without ",(0,s.jsx)(t.code,{children:"$"}),", but with it\nthe syntax is shorter, more readable and more expressive."]}),"\n",(0,s.jsx)(t.p,{children:"Basic usage is simply to pass state into an operation:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"upsert('patient', $.data.patients[0]);\n"})}),"\n",(0,s.jsx)(t.p,{children:"You can use it inside an object (so long as that object is passed to an\noperation):"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"create('agent', {\n  name: $.patient.name,\n  country: $.patient.country,\n});\n"})}),"\n",(0,s.jsx)(t.p,{children:"You can use it inside a string template:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get(`/patients/${$.patient.id}`);\n"})}),"\n",(0,s.jsx)(t.p,{children:"Or inside other expressions, like concatenation:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"create({\n  name: $.patients[0].first_name + ' ' + $.patients[0].last_name,\n});\n"})}),"\n",(0,s.jsx)(t.p,{children:"Or mathematics:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"create({\n  profit: $.report.revenue - $.report.expenses,\n});\n"})}),"\n",(0,s.jsx)(t.p,{children:"You can use it when mapping data structures:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"create('user', {\n  countryCode: countries[$.location.country],\n});\n"})}),"\n",(0,s.jsxs)(t.p,{children:["And you can use it in nested operations like, with ",(0,s.jsx)(t.code,{children:"each()"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"each($.data.patients,\n  post(`patients/${$.data.patient.id}`, $.data.patient)\n);\n"})}),"\n",(0,s.jsx)(t.h3,{id:"-is-not-state",children:"$ is not state"}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"$"})," operator is ",(0,s.jsx)(t.strong,{children:"not"})," an alias for ",(0,s.jsx)(t.code,{children:"state"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["It cannot be used in place of the ",(0,s.jsx)(t.code,{children:"state"})," variable. It cannot be assigned to, or\nbe on the left hand side of an assignment, and can only be used inside an\nargument to a function"]}),"\n",(0,s.jsx)(t.p,{children:"This also means that Lazy State Operator can only be used to READ from state. It\ncannot be used to assign to state directly."}),"\n",(0,s.jsx)(t.p,{children:"These examples are all errors:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"\u274c const url = $.data.url;\nget(url);\n\n\u274c get(() => $.data.url);\n\n\u274c $.data.x = fn();\n\n\u274c fn(state => {\n  $.data.x = 10;\n});\n"})}),"\n",(0,s.jsxs)(a,{children:[(0,s.jsx)("summary",{children:"Compilation rules for advanced users"}),(0,s.jsx)(t.p,{children:'How does the Lazy State Operator work? The "magic" is in the compiler.'}),(0,s.jsxs)(t.p,{children:["Simply put, whenever the compiler sees ",(0,s.jsx)(t.code,{children:"$"})," in your code, it replaces it with\n",(0,s.jsx)(t.code,{children:"(state) => state"}),". Like this:"]}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"get($.data.url) // compiles to get((state) => state.data.url)\n"})}),(0,s.jsxs)(t.p,{children:["In practice, the rules are a little more complicated than that. When seeing a\n",(0,s.jsx)(t.code,{children:"$"})," operator, the compiler will first check that ",(0,s.jsx)(t.code,{children:"$"})," hasn't been declared as a\nvariable or parameter. If it has, it'll ignore it entirely."]}),(0,s.jsxs)(t.p,{children:["But if the ",(0,s.jsx)(t.code,{children:"$"})," is deemed to be a State Operator, the compiler will first replace\nthe ",(0,s.jsx)(t.code,{children:"$"})," symbol with ",(0,s.jsx)(t.code,{children:"state"}),", then find the operation which is being called, then\nwrap the argument in an arrow function (if it isn't already)."]}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"get({ url: $.data.url }) // compiles to get((state) => { url: state.data.url })\n"})}),(0,s.jsx)(t.p,{children:'This "hoisting" of the arrow function enables more complex and interesting\nexpressions to be used with lazy state, like templated string literals or\ndynamic object lookups.'}),(0,s.jsxs)(t.p,{children:["If you're curious (or need to troubleshoot something) you can use the\n",(0,s.jsx)(t.code,{children:"openfn compile"})," command in the CLI to see the compiled code, which will tell\nyou how the compiler is treating your State operators."]})]}),"\n",(0,s.jsx)(t.h2,{id:"operations-and-promises",children:"Operations and Promises"}),"\n",(0,s.jsx)(t.admonition,{type:"tip",children:(0,s.jsxs)(t.p,{children:["Promise support was added in July 2024 to ",(0,s.jsx)(t.code,{children:"@openfn/compiler@0.2.0"}),". It is\navailable in the CLI from version 1.7.0 and the Lightning Worker from versison\n1.4.0."]})}),"\n",(0,s.jsxs)(t.p,{children:["Operations behave like Javascript Promises in that they have ",(0,s.jsx)(t.code,{children:".then()"})," and\n",(0,s.jsx)(t.code,{children:".catch()"})," functions. This is useful for creating your own callbacks and error\nhandling."]}),"\n",(0,s.jsx)(t.admonition,{title:"Note for developers",type:"info",children:(0,s.jsx)(t.p,{children:"Support for .then() is added by the compiler. Operations technically don't\nreturn a Promise, they return a function, but the compiler will modify the job\ncode and wrap the operation in a deferred promise call."})}),"\n",(0,s.jsx)(t.h3,{id:"callback-with-then",children:"Callback with then()"}),"\n",(0,s.jsxs)(t.p,{children:["Chaining ",(0,s.jsx)(t.code,{children:"then()"})," is available on every operation, and contains a callback to be\nexecuted once the operation has completed."]}),"\n",(0,s.jsxs)(t.p,{children:["The callback will receive the state returned by the operation, and must return\nthe state object to be passed to the ",(0,s.jsx)(t.em,{children:"next"})," operation."]}),"\n",(0,s.jsx)(t.p,{children:"For example:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get($.data.url).then(state => {\n  console.log(state);\n  return state; // always remember to return state!\n});\n"})}),"\n",(0,s.jsxs)(t.p,{children:["If you're familiar with the callback pattern in our adaptors, ",(0,s.jsx)(t.code,{children:".then()"})," performs\nexactly the same job as a callback. It gives you the opportunity to transform\nthe state returned by some operation."]}),"\n",(0,s.jsxs)(t.p,{children:["Usually, you don't need a callback or a ",(0,s.jsx)(t.code,{children:".then()"})," - you can just execute\noperations serially. The following code is functionally the same as the prior\nexample:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get($.data.url);\nfn(state => {\n  console.log(state);\n  return state; // always remember to return state!\n});\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Where ",(0,s.jsx)(t.code,{children:".then()"})," is particularly useful is when composing operations with ",(0,s.jsx)(t.em,{children:"scoped\nstate"}),", like with ",(0,s.jsx)(t.code,{children:"each()"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"each($.items, post(`patient/${$.data.id}`, $.data));\n"})}),"\n",(0,s.jsx)(t.admonition,{type:"tip",children:(0,s.jsxs)(t.p,{children:["You can read more about the ",(0,s.jsx)(t.code,{children:"each()"})," operation in\n",(0,s.jsx)(t.a,{href:"#iteration-with-each",children:"Iteration with Each"}),"."]})}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"each"})," function will take an array and, for each item, invoke a callback\nwith a scoped state. This means it takes your state object and sets the item\nunder iteration to ",(0,s.jsx)(t.code,{children:"state.data"}),". In other words, ",(0,s.jsx)(t.code,{children:"state.data"})," inside the\ncallback is ",(0,s.jsx)(t.em,{children:"scoped"})," to each item in the array."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"each($.items, state => {\n  console.log(state.data); // each item in the items array\n  console.log(state.index); // the current index of iteration\n  return state;\n});\n"})}),"\n",(0,s.jsxs)(t.p,{children:["So in the example above, every item in ",(0,s.jsx)(t.code,{children:"state.items"})," will be passed to a HTTP\n",(0,s.jsx)(t.code,{children:"post()"})," function, where the id will be embedded in a URL and the item itself\nwill be uploaded to the server."]}),"\n",(0,s.jsx)(t.p,{children:"What if you want to do something with the scoped state AFTER the request? Maybe\nyou want to check the status code and log an error, or maybe you want to mutate\nthe data before writing it back to state."}),"\n",(0,s.jsxs)(t.p,{children:["You can chain ",(0,s.jsx)(t.code,{children:"operation().then()"})," for this:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"each(\n  $.items,\n  post(`patient/${$.data.id}`, $.data).then(state => {\n    state.completed.push(state.data);\n    return state;\n  })\n);\n"})}),"\n",(0,s.jsx)(t.p,{children:"Now this expression will:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Iterate over each item in ",(0,s.jsx)(t.code,{children:"state.items"})]}),"\n",(0,s.jsxs)(t.li,{children:["Call the post operation with scoped state (ie, the item in ",(0,s.jsx)(t.code,{children:"state.data"}),")"]}),"\n",(0,s.jsxs)(t.li,{children:["Once the post is complete, pass the result as scoped state into the ",(0,s.jsx)(t.code,{children:".then()"}),"\ncallback"]}),"\n"]}),"\n",(0,s.jsx)(t.h3,{id:"error-handling-with-catch",children:"Error handling with catch()"}),"\n",(0,s.jsx)(t.p,{children:"Most adaptors will throw an error when something goes wrong, which may result in\nthe job (and maybe even workflow) ending early."}),"\n",(0,s.jsxs)(t.p,{children:["Because every operation has a ",(0,s.jsx)(t.code,{children:"catch()"}),", you have the opportunity in your job\ncode to intercept and even suppress the error."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get('patients').catch((error, state) => {\n  state.error = error;\n  return state;\n});\n"})}),"\n",(0,s.jsx)(t.p,{children:"The error callback is passed two arguments: the error thrown by the adaptor, and\nthe state object."}),"\n",(0,s.jsx)(t.p,{children:"If you want to continue execution, you should return the state object from the\ncatch. This state will then be passed into the next operation."}),"\n",(0,s.jsxs)(t.p,{children:["If you ",(0,s.jsx)(t.em,{children:"do"})," want to terminate execution, perhaps with some logging for debugging\nor with a different error, you should throw from inside the catch handler."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get('patients').catch((error, state) => {\n  console.log('Error ocurred faithing patients', error);\n  throw error;\n});\n"})}),"\n",(0,s.jsx)(t.h2,{id:"mapping-objects",children:"Mapping Objects"}),"\n",(0,s.jsx)(t.p,{children:"A common use-case in OpenFn fn is to map/convert/transform an object from system\nA to the format of system B."}),"\n",(0,s.jsx)(t.p,{children:"We often do this in multiple Jobs in the same workflow, so that we can use\ndifferent adaptors. But in this example we'll work with three operations in one\njob with the http adaptor: one to fetch data, one to transform, and one to\nupload:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"// Fetch an object from one system\nget('https://www.system-a.com/api/patients/123');\n\n// Transform it\nfn(state => {\n  // Read the data we fetched\n  const obj = state.data;\n\n  // convert it by mapping properties from one object to the o ther\n  state.uploadData = {\n    id: obj.id,\n    name: `${obj.first_name} ${obj.last_name}`,\n    metadata: obj.user_data,\n  };\n\n  // Don't forget to return state!\n  return state;\n});\n\n// Post it elsewhere\npost('https://system-b.com/api/v1/records/123', () => state.uploadData);\n"})}),"\n",(0,s.jsxs)(t.admonition,{title:"Batch conversions",type:"tip",children:[(0,s.jsx)(t.p,{children:"These examples show a single object being converted - but sometimes we need to\nconvert many objects at once."}),(0,s.jsx)(t.p,{children:"See the each() example below to see how we can do this with the each operator."}),(0,s.jsx)(t.p,{children:"You can also use a Javascript map() or forEach() function inside a callback or\nfn block."}),(0,s.jsx)(t.p,{children:"Generally it's easier to spread your job logic across many top-level operations,\neach responsible for one task, rather than having a few deeply nested\noperations."})]}),"\n",(0,s.jsx)(t.p,{children:"This is fine - and actually, having lots of operations which each do a small\ntask is best practices. It makes code more readable and testable, as well as\neasier to reason about and debug when things go wrong."}),"\n",(0,s.jsx)(t.p,{children:"However, every operation argument accepts a function (allowing lazy state\nreferences, as described above) giving us the opportunity to perform the\nconversion in-line in the post operation, for example:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"// Fetch an object from one system\nget('https://www.system-a.com/api/patients/123');\n\n// Transform and post it elsewhere\npost('https://system-b.com/api/v1/records/123', state => ({\n  id: state.data.id,\n  name: `${state.data.first_name} ${state.data.last_name}`,\n  metadata: state.data.user_data,\n}));\n"})}),"\n",(0,s.jsx)(t.p,{children:"Effective use of these lazily-resolved functions is critical to writing good\nOpenFn jobs."}),"\n",(0,s.jsx)(t.h2,{id:"iteration-with-each",children:"Iteration with each()"}),"\n",(0,s.jsx)(t.p,{children:"A very common use-case in data integration is to convert data from one format to\nanother. Usually this involves iterating over an array of items, converting the\nvalues, and mapping them into a new array."}),"\n",(0,s.jsxs)(t.p,{children:["In OpenFn, we can use the ",(0,s.jsx)(t.code,{children:"each()"})," operator to do this."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"each(\n  '$.data.items[*]',\n  get(state => `/patients/${state.data.id}`)\n);\n"})}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"each()"})," operator takes a JSON path string as its first argument, which\npoints to some part of state. In JSON path, we use ",(0,s.jsx)(t.code,{children:"$"})," to refer to the root, and\ndot notation to chain a path, and ",(0,s.jsx)(t.code,{children:"[*]"}),' to "select" an array of items. The\nsecond argument is an Operation, which will receive each item at the end of the\njson path as ',(0,s.jsx)(t.code,{children:"state.data"}),", but otherwise will receive the rest of the state\nobject."]}),"\n",(0,s.jsx)(t.p,{children:"So we can iterate over each item and write it back to state, like this:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:'fn((state) => {\n  // Initialize an array into state to use later\n  state.transformed = []\n  return state;\n})\neach("$.items[*]", fn(state) => {\n  // Pull the next item off the state\n  const next = state.data;\n\n  // Transform it\n  const transformed = { ...next };\n\n  // Write it back to the top-level transformed array on state\n  state.transformed.push(transformed)\n\n  // Always return state\n  return state;\n})\n'})}),"\n",(0,s.jsx)(t.p,{children:"Or we can pass in another operation, like this Salesforce example:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"each(\n  '$.form.participants[*]',\n  upsert('Person__c', 'Participant_PID__c', state => ({\n    Participant_PID__c: state.pid,\n    First_Name__c: state.participant_first_name,\n    Surname__c: state.participant_surname,\n  }))\n);\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Each participant is upserted into Salesforce, with its salesforce fields mapped\nto values in the ",(0,s.jsx)(t.code,{children:"participants"})," array."]}),"\n",(0,s.jsxs)(t.admonition,{title:"JSON paths",type:"info",children:[(0,s.jsxs)(t.p,{children:["The use of a JSON path string as the first argument to ",(0,s.jsx)(t.code,{children:"each()"})," allows the\nruntime to lazily evaluate the value at that path -\n",(0,s.jsx)(t.a,{href:"#reading-state-lazily",children:"See Reading state lazily"}),"."]}),(0,s.jsxs)(t.p,{children:["Not all operations support a JSON path string - refer to\n",(0,s.jsx)(t.a,{href:"/adaptors",children:"individual adaptor docs"})," for guidance."]})]}),"\n",(0,s.jsx)(t.h2,{id:"variable-initialisation",children:"Variable initialisation"}),"\n",(0,s.jsx)(t.p,{children:"A common pattern is to need to declare some variables at the state of the job.\nThese could be static values to use later, functions to be called multiple times\nthrough the job, or bits of state that we want to return at the end."}),"\n",(0,s.jsxs)(t.p,{children:["It is considered best practice to use an ",(0,s.jsx)(t.code,{children:"fn()"})," block to do this at the start of\nthe job, creating custom properties on state, for example:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"fn(state => {\n  // Create an array to hold the final results of the job\n  state.results = [];\n\n  // Create a lookup index to be used during the job\n  state.lookup = {};\n\n  state.keyMap = {\n    AccountName: 'C__Acc_Name', // capture various static mappings for transformation\n  };\n\n  state.maxPageSize = 200; // Define some config options\n\n  state.convertToSF = item => {\n    /* ... */\n  }; // A function to be re-used\n\n  return state;\n});\n\n// the rest of your job code goes here\nget('/abc');\n\nfn(state => {\n  /* ... */\n\n  // Only return the results array as output from the job\n  return { result: state.results };\n});\n"})}),"\n",(0,s.jsx)(t.h2,{id:"using-cursors",children:"Using Cursors"}),"\n",(0,s.jsx)(t.p,{children:"Sometimes it is useful to maintain a rolling cursor position on the backend\ndatasource. This can be used in a cron-based workflow, for example, to query the\ndatabase for new records since the last run."}),"\n",(0,s.jsx)(t.p,{children:"In a cron workflow, OpenFn will pass the previous state into the next state - so\nstate persists across runs. We can take advantage of that to pick up where we\nleft off."}),"\n",(0,s.jsxs)(t.p,{children:["You can use the ",(0,s.jsx)(t.a,{href:"/adaptors/packages/common-docs#cursor",children:(0,s.jsx)(t.code,{children:"cursor()"})})," operation,\nwhich is built-in to most adaptors, to make cursor management easier."]}),"\n",(0,s.jsxs)(a,{children:[(0,s.jsxs)(t.p,{children:[(0,s.jsx)("summary",{children:"Version support"}),"\nThe cursor operation was introduced to ",(0,s.jsx)("code",{children:"@openfn/language-common"})," in version\n",(0,s.jsx)("code",{children:"1.13.0"})," (released April 2024)."]}),(0,s.jsx)("br",{}),(0,s.jsx)("br",{}),(0,s.jsxs)(t.p,{children:["Any adaptor which uses common ",(0,s.jsx)("code",{children:"1.12.0"})," or less will not support the\ncursor operation. Consider updating to the latest adaptor version to take advantage\nof this functionality."]})]}),"\n",(0,s.jsx)(t.h3,{id:"setting-the-cursor-value",children:"Setting the cursor value"}),"\n",(0,s.jsx)(t.p,{children:"To use a cursor from a fixed date, just add a line like this to the top of your\njob:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"cursor('2024-04-08T12:00:00.0000');\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Using a string value like this will set the cursor to ",(0,s.jsx)(t.em,{children:"always"})," use the date you\nprovided."]}),"\n",(0,s.jsx)(t.p,{children:'If you are using a date cursor, you can also pass in natural language strings\nlike "now", "today", "yesterday", "24 hours ago" or "start" (ie, the time the\njob started).'}),"\n",(0,s.jsxs)(t.admonition,{title:"Timezones",type:"tip",children:[(0,s.jsx)(t.p,{children:'Relative dates like "today" will be converted into a Javascript Date using the\nsystem locale.'}),(0,s.jsx)(t.p,{children:"If you're in the CLI that means times will be calculated in your local system\ntime; or if you're running on Lightning it'll use the Lightning system time\n(usually UTC)."}),(0,s.jsx)(t.p,{children:"The cursor function will log the exact time, including the time zone, it is\nusing."})]}),"\n",(0,s.jsx)(t.p,{children:"To use a rolling or manual cursor, you should pass the cursor value from state.\nYou might want to include a default value too:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"cursor(state => state.cursor, { defaultValue: '2024-04-08T12:00:00.0000' });\n"})}),"\n",(0,s.jsx)(t.h3,{id:"using-the-cursor",children:"Using the cursor"}),"\n",(0,s.jsxs)(t.p,{children:["To use the cursor in your job, just use ",(0,s.jsx)(t.code,{children:"state.cursor"})," in your queries like any\nother state property."]}),"\n",(0,s.jsx)(t.p,{children:"The usage will be different depending on the adaptor you're using. Here's how\nyou might build a URL with query parameters with the HTTP adaptor:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get(state => `/registrations?since=${state.cursor}`);\nfn(/* do something good with your data */);\n"})}),"\n",(0,s.jsx)(t.p,{children:"This will read the cursor value off the state object, insert it into a string,\nand pass it into a HTTP query."}),"\n",(0,s.jsx)(t.p,{children:"Or perhaps you want to build the cursor into an object:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get('registrations', state => {\n  query: {\n    fromdate: state.cursor;\n  }\n});\n"})}),"\n",(0,s.jsx)(t.p,{children:"The actual value of a cursor is arbitrary. You can use a string, a Date, a page\nnumber or object, or anything you like."}),"\n",(0,s.jsx)(t.p,{children:"You may want to advance the cursor at the end of a job ready, for the next run:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"cursor(state => state.cursor, { defaultValue: 'today' });\nget(`/registrations?since={date.cursor}`);\nfn(/* do something good with your data */);\ncursor('now');\n"})}),"\n",(0,s.jsx)(t.h3,{id:"manual-cursors",children:"Manual Cursors"}),"\n",(0,s.jsx)(t.p,{children:"It's often useful to manually set the cursor position - usually when testing or\ndebugging. Maybe yesterday's run failed and you want to repeat it, or maybe\nyou're testing out some new functionality and you want to experiment with\ndifferent cursors."}),"\n",(0,s.jsx)(t.p,{children:"You can do this by setting a cursor value on input state, like this:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:'{\n  "cursor": "today",\n}\n'})}),"\n",(0,s.jsxs)(t.p,{children:["You can do this by triggering a manual run in the platform's\n",(0,s.jsx)(t.a,{href:"/documentation/build/steps/step-editor",children:"Job Inspector"}),", or you can pass the\nstate as input to the CLI:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"$ openfn job.js -s state.json -a http\n"})}),"\n",(0,s.jsxs)(a,{children:[(0,s.jsxs)(t.p,{children:[(0,s.jsx)("summary",{children:"Manual cursors on v1"}),"\nPlatform v1 does not allow input states to be freely defined, so setting a\nmanual cursor is a little more difficult."]}),(0,s.jsx)(t.p,{children:"You have to hard-code the manual cursor into the run so that the state cursor is\nignored:"}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"cursor('2024-03-12');\n"})}),(0,s.jsx)(t.p,{children:"This line should be commented out in production runs."}),(0,s.jsx)(t.p,{children:"Alternatively, you can use the defaultValue option. This will work so long you\nrun without any initial state:"}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"cursor(state => state.cursor, { defaultValue: '2024-03-12' });\n"})})]}),"\n",(0,s.jsx)(t.h3,{id:"cursor-options",children:"Cursor Options"}),"\n",(0,s.jsxs)(t.p,{children:["The second argument to ",(0,s.jsx)(t.code,{children:"cursor()"})," is an options object. You can use this to set\nthe ",(0,s.jsx)(t.code,{children:"defaultValue"})," or the ",(0,s.jsx)(t.code,{children:"key"})," the cursor should use (defaults to ",(0,s.jsx)(t.code,{children:"cursor"}),")"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"cursor(state => state.cursor, { defaultValue: '2024-03-12', key: 'page' });\n"})}),"\n",(0,s.jsx)(t.h3,{id:"formatting-the-value",children:"Formatting the value"}),"\n",(0,s.jsxs)(t.p,{children:["If you're using a service which doesn't use standard date formats, or you wish\nto map a number of input formats into a consistent standard, you can use the\n",(0,s.jsx)(t.code,{children:"format"})," option."]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.code,{children:"format"})," takes a function which accepts the current cursor value as an argument,\nand returns a formatted or updated value. This is called just before the cursor\nis assigned to state."]}),"\n",(0,s.jsx)(t.p,{children:"For example, to use a Javascript Date as your cursor:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"cursor('today', { format: c => new Date(c) });\n"})}),"\n",(0,s.jsx)(t.p,{children:"The formatter will run after any natural-language processing, so you can\nintercept and convert the value to whatever you need."}),"\n",(0,s.jsxs)(t.p,{children:["You can combine this with\n",(0,s.jsx)(t.a,{href:"https://date-fns.org/v3.6.0/docs/format",children:(0,s.jsx)(t.code,{children:"dateFns.format"})})," to use a custom\ntimestamp:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"cursor('today', { format: c => dateFns.format(new Date(c), 'dd/mm/yyyy') });\n"})}),"\n",(0,s.jsx)(t.p,{children:"You can add as much logic as you wish to your formatter - it's just a regular\nJavascript function"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"cursor('today', {\n  format: c => {\n    if (typeof c === 'number') {\n      return { page: c, count: 20 };\n    }\n    return c;\n  },\n});\n"})}),"\n",(0,s.jsx)(t.h2,{id:"cleaning-final-state",children:"Cleaning final state"}),"\n",(0,s.jsx)(t.p,{children:'When your job has completed, the final state object will be "returned" by the\nopenfn runtime.'}),"\n",(0,s.jsx)(t.p,{children:"This final state must be serialisable to JSON."}),"\n",(0,s.jsx)(t.p,{children:"If there are more steps in the workflow, the state will be passed to those\nsteps. If running on the app (Lightning), the final state will be saved as a\ndataclip. Or if running in the CLI, the final state will be written to disk."}),"\n",(0,s.jsx)(t.p,{children:"It's often desirable to clean up your final state so that any unused information\nis removed. This reduces the size of your saved data, but could also be an\nimportant security consideration."}),"\n",(0,s.jsxs)(t.p,{children:["The best practice is to use a closing ",(0,s.jsx)(t.code,{children:"fn()"})," block which returns just the keys\nyou need:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"fn(state => {\n  return {\n    data: state.data,\n  };\n});\n"})}),"\n",(0,s.jsx)(t.p,{children:"You could use the spread operator to override some keys:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"fn(state => {\n  return {\n    ...state,\n    secretStuff: null,\n  };\n});\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Or use the ",(0,s.jsx)(t.em,{children:"rest"})," operator:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"fn(state => {\n  const { username, password, secrets, ...rest } = state;\n  return rest;\n});\n"})}),"\n",(0,s.jsx)(t.h2,{id:"referencing-credential-secrets-in-your-job-code",children:"Referencing credential secrets in your job code"}),"\n",(0,s.jsxs)(t.p,{children:["If you want to reference any credential secrets in your job code, you can still map keys from your ",(0,s.jsx)(t.code,{children:"state.configuration"}),". See example below that will dynamically map the username and password from your ",(0,s.jsx)(t.code,{children:"configuration"}),' (or "credential" if using the app) into your http request body.']}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"post('/api/v1/auth/login', {\n   body: {\n    username: $.configuration.username, //map the UN from credential\n    password: $.configuration.password //map the PW from credential\n   },\n   headers: {'content-type': 'application/json'},\n })\n"})}),"\n",(0,s.jsx)(t.admonition,{title:"OpenFn scrubs Configuration & Functions from final state",type:"info",children:(0,s.jsxs)(t.p,{children:["OpenFn will automatically scrub the ",(0,s.jsx)(t.code,{children:"configuration"})," key and any functions from\nyour final state, as well as from logs if running workflows on the app. This is to help ensure that your credential secrets are kept secure and won't be leaked into History."]})}),"\n",(0,s.jsx)(t.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,s.jsx)(t.p,{children:"If something goes wrong, it's usually best to let your jobs fail."}),"\n",(0,s.jsx)(t.p,{children:"Failing jobs will generate the right status on the OpenFn app and communicate\nthat something is wrong."}),"\n",(0,s.jsx)(t.p,{children:"Don't worry, errors happen all the time! Even well established workflows will\noccasionally throw an error because of some unexpected data somewhere in the\npipeline. It's a fact of life, but the most important thing is to be aware of\nit."}),"\n",(0,s.jsx)(t.p,{children:"Errors should be thrown from the job without much ceremony, and will be caught\nby the runtime to be processed appropriately."}),"\n",(0,s.jsx)(t.p,{children:"If a Job does throw an error, it will be logged and written to the final state,\nso it should be easy to find and identify the cause."}),"\n",(0,s.jsx)(t.p,{children:"It is common practice in a Workflow to let a Job error, and then perform some\ntask - like emailing a system admin that there was a problem."}),"\n",(0,s.jsx)(t.p,{children:"When processing batches of data, you might want to catch errors occurring on\nindividual items and write them to state. That way one bad item won't ruin a\nwhole batch, and you know which items succeeded and which failed. You can then\nthrow an exception to recognise that the job has failed."}),"\n",(0,s.jsx)(t.h2,{id:"compilation",children:"Compilation"}),"\n",(0,s.jsx)(t.p,{children:"The code you write isn't technically executable JavaScript. You can't just run\nit through node.js. It needs to be transformed or compiled into portable vanilla\nJS code."}),"\n",(0,s.jsx)(t.admonition,{type:"warning",children:(0,s.jsx)(t.p,{children:"This is advanced stuff more focused at JavaScript developers and the technically\ncurious. These docs are not intended to be complete - just a nudge in the right\ndirection to help understand how jobs work."})}),"\n",(0,s.jsx)(t.p,{children:"The major differences between OpenFn code and JavaScript are:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"The top-level functions in the code are executed synchronously (in sequence),\neven if they contain asynchronous code."}),"\n",(0,s.jsx)(t.li,{children:"OpenFn code does not contain import statements (although technically it can).\nThese are compiled in."}),"\n",(0,s.jsx)(t.li,{children:"Compiled code is a JavaScript ESM module which default-exports an array of\nasync functions. These functions are imported and executed by the runtime."}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"It shouldn't be necessary to understand compilation in detail, but you should be\naware that the code you write is not the code you run."}),"\n",(0,s.jsxs)(t.p,{children:["If you're a JavaScript developer, understanding some of these changes might help\nyou better understand how OpenFn works. Using the CLI, you can run\n",(0,s.jsx)(t.code,{children:"openfn compile path/to/job.ja -a <adaptor-name>"})," to see compiled code."]}),"\n",(0,s.jsx)(t.p,{children:"Here's an example of how a simple job looks in compilation:"}),"\n",(0,s.jsx)(t.p,{children:"This job:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"get('/patients');\n"})}),"\n",(0,s.jsx)(t.p,{children:"Compiles to this JavaScript module:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-js",children:"import { get } from '@openfn/language-http';\nexport * from '@openfn/language-http';\nexport default [get('/patients')];\n"})}),"\n",(0,s.jsx)(t.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,s.jsx)(t.p,{children:"The best way to learn how to write OpenFn jobs is to write OpenFn jobs."}),"\n",(0,s.jsxs)(t.p,{children:["You can ",(0,s.jsx)(t.a,{href:"/documentation/cli",children:"get started with CLI"})," and start running jobs\nlocally. Then take a look at the ",(0,s.jsx)(t.a,{href:"/documentation/cli-challenges",children:"CLI Challenge"}),"\nto really exercise your job writing skills."]}),"\n",(0,s.jsxs)(t.p,{children:["If you're ready to start using the app, take a look at this guide to\n",(0,s.jsx)(t.a,{href:"/documentation/build/workflows",children:"create your first Workflow"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["Workflow design is a non-trivial problem, so you might also like to review the\nWorkflow ",(0,s.jsx)(t.a,{href:"/documentation/design/design-overview",children:"Design Process docs"}),"."]}),"\n",(0,s.jsx)(t.admonition,{title:"Questions?",type:"info",children:(0,s.jsxs)(t.p,{children:["If you have any job-writing questions, ask on\n",(0,s.jsx)(t.a,{href:"https://community.openfn.org",children:"Community"})," to seek assistance from the OpenFn\ncore team and other implementers."]})})]})}function h(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}}}]);