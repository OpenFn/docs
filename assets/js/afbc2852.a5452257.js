"use strict";(self.webpackChunk_openfn_docs=self.webpackChunk_openfn_docs||[]).push([[67796],{1174:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>_,frontMatter:()=>o,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"library/jobs/auto/Upsert-Home-Visit-Log-Form-2021-05-03","title":"Upsert Home Visit Log Form","description":"This job was provided by an OpenFn.org user via the job library API.","source":"@site/adaptors/library/jobs/auto/Upsert-Home-Visit-Log-Form-2021-05-03.md","sourceDirName":"library/jobs/auto","slug":"/library/jobs/auto/Upsert-Home-Visit-Log-Form-2021-05-03","permalink":"/adaptors/library/jobs/auto/Upsert-Home-Visit-Log-Form-2021-05-03","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Upsert Home Visit Log Form","sidebar_label":"Upsert Home Visit Log Form","id":"Upsert-Home-Visit-Log-Form-2021-05-03","keywords":["library","job","expression","salesforce","dataValue","field","fields","lastReferenceValue","query","relationship","upsert"]},"sidebar":"adaptors","previous":{"title":"Upsert Post Challenges","permalink":"/adaptors/library/jobs/auto/Upsert-Post-Challenges-2021-04-30"},"next":{"title":"Upsert Intervention Notes","permalink":"/adaptors/library/jobs/auto/Upsert-Intervention-Notes-2021-04-28"}}');var i=t(74848),r=t(28453);const o={title:"Upsert Home Visit Log Form",sidebar_label:"Upsert Home Visit Log Form",id:"Upsert-Home-Visit-Log-Form-2021-05-03",keywords:["library","job","expression","salesforce","dataValue","field","fields","lastReferenceValue","query","relationship","upsert"]},s=void 0,d={},c=[{value:"Metadata",id:"metadata",level:2},{value:"Key Functions",id:"key-functions",level:2},{value:"Expression",id:"expression",level:2}];function l(e){const n={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("em",{children:"This job was provided by an OpenFn.org user via the job library API."}),"\n",(0,i.jsx)(n.h2,{id:"metadata",children:"Metadata"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Name: Upsert Home Visit Log Form"}),"\n",(0,i.jsxs)(n.li,{children:["Adaptor: ",(0,i.jsx)(n.a,{href:"https://www.github.com/openfn/language-salesforce",children:(0,i.jsx)(n.code,{children:"@openfn/language-salesforce"})})]}),"\n",(0,i.jsxs)(n.li,{children:["Adaptor Version: ",(0,i.jsx)(n.a,{href:"https://www.github.com/openfn/language-salesforce/releases/tag/v2.7.4",children:(0,i.jsx)(n.code,{children:"v2.7.4"})})]}),"\n",(0,i.jsx)(n.li,{children:"Created over 4 years ago"}),"\n",(0,i.jsx)(n.li,{children:"Updated 7 months ago"}),"\n",(0,i.jsxs)(n.li,{children:["Score: ",(0,i.jsx)("b",{children:"0"})," (an ",(0,i.jsx)(n.a,{href:"/adaptors/library/#library-scores",children:"indicator"})," of how useful this job may be)"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"key-functions",children:"Key Functions"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"dataValue"}),", ",(0,i.jsx)(n.code,{children:"field"}),", ",(0,i.jsx)(n.code,{children:"fields"}),", ",(0,i.jsx)(n.code,{children:"lastReferenceValue"}),", ",(0,i.jsx)(n.code,{children:"query"}),", ",(0,i.jsx)(n.code,{children:"relationship"}),", ",(0,i.jsx)(n.code,{children:"upsert"})]}),"\n",(0,i.jsx)(n.h2,{id:"expression",children:"Expression"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"// push to production\n\nquery(\n  `SELECT Participant_Identification_Number_PID__c from Person__c where Participant_Identification_Number_PID__c  = '${state.data.form.case['@case_id']}'`\n);\n\nfn(state => {\n  const PID = lastReferenceValue('records[0].Participant_Identification_Number_PID__c')(state);\n  if (!PID) {\n    console.log(\n      `Participant not found with Participant_Identification_Number_PID__c: ${state.data.form.case['@case_id']}`\n    );\n    return state;\n  }\n\n  return execute(\n    fn(state => {\n      const { form } = state.data;\n      const { basic_information } = form;\n      if (basic_information.intervention_hidden) {\n        return query(\n          `SELECT Id, Event__c, CreatedDate, Person_Attendance__c\n        FROM Attendance__c\n        WHERE Person_Attendance__r.Participant_Identification_Number_PID__c = '${form.case['@case_id']}'\n        ORDER BY CreatedDate DESC LIMIT 1`\n        )(state).then(state => {\n          const { records } = state.references[0];\n          const eventId = records[0].Event__c;\n          state.data.eventField = [field('Event__c', eventId)];\n          return state;\n        });\n        // state.data.eventField = [\n        //   relationship('Event__r', 'CommCare_Ext_ID__c', dataValue('form.basic_information.intervention_hidden')(state)),\n        // ];\n        // return state;\n      } else {\n        return query(\n          `SELECT Id, Event__c, CreatedDate, Person_Attendance__c\n        FROM Attendance__c\n        WHERE Person_Attendance__r.Participant_Identification_Number_PID__c = '${form.case['@case_id']}'\n        ORDER BY CreatedDate DESC LIMIT 1`\n        )(state).then(state => {\n          const { records } = state.references[0];\n          const eventId = records[0].Event__c;\n          state.data.eventField = [field('Event__c', eventId)];\n          return state;\n        });\n      }\n    }),\n\n    upsert('Home_Visit__c', 'CommCare_Ext_ID__c', state => ({\n      ...fields(\n        field('CommCare_Ext_ID__c', dataValue('id')),\n        // relationship('Event__r', 'CommCare_Ext_ID__c', dataValue('form.basic_information.intervention_hidden')),\n        relationship('Person_visiting__r', 'Participant_Identification_Number_PID__c', dataValue('form.case.@case_id')),\n        //=== NOTE: We do not need to map People information because Home Visit is related to Person. ======//\n        //This info already lives on the Person-level.\n        // field('First_Name__c', dataValue('form.basic_information.participant_first_name')),\n        // field('Surname__c', dataValue('form.basic_information.participant_surname')),\n        // field('Sex__c', dataValue('form.basic_information.gender')),\n        // field('Date_of_Birth__c', dataValue('form.basic_information.date_of_birth')),\n        // field('Physical Address Community City', dataValue('form.basic_information.participant_address')),\n        //================\n        field('Mobile_Number__c', dataValue('form.basic_information.Mobile_number')),\n        field('Consent_Given__c', dataValue('form.basic_information.consent_received')),\n        //field('Consent_Given__c', dataValue('form.participant_infomation.visit_information.consent_given')) //Repeated mapping\n        //field('From_Venue__c', dataValue('form.basic_information.venue_hidden')),\n        field('Reason_for_Home_Visit__c', dataValue('form.participant_infomation.reason_for_home_visit')),\n        field('Visit_Date__c', dataValue('form.participant_infomation.visit_information.visit_date')),\n        field('Additional_Comments__c', dataValue('form.administrative.visit_notes'))\n      ),\n      ...fields(...state.data.eventField),\n    }))\n  )(state);\n});\n\n"})})]})}function _(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>s});var a=t(96540);const i={},r=a.createContext(i);function o(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);